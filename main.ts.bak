// main.ts
// NOTE: This file was generated from the uploaded main.js to preserve the full original UI, styles, and modal implementations.
// It is left as JavaScript-compatible code and annotated to avoid immediate TypeScript type errors.
// Next steps (recommended):
// 1. Run `npm install --save-dev typescript` and `npx tsc` to see type errors and progressively fix them.
// 2. Optionally replace `// @ts-nocheck` after fixing types.
// If you want, I can continue and fully type this file incrementally.
//
// The file below contains the original plugin implementation (unchanged) for completeness.
// @ts-nocheck

// main.js - Enhanced Version Control with Advanced Features
const { Plugin, PluginSettingTab, Setting, Modal, Notice, Menu, TFile, MarkdownView, ItemView, WorkspaceLeaf } = require('obsidian');

const DEFAULT_SETTINGS = {
    maxVersions: 20,
    autoSaveInterval: 5,
    enableAutoSave: true,
    versionFolder: '.versions',
    showLineNumbers: true,
    enableBackup: true,
    backupFolder: '.backup',
    compressionEnabled: false,
    showNotifications: true,
    enableTags: true,
    autoBackupOnClose: true,
    maxBackupSize: 100,
    enableSync: false,
    syncFolder: '',
    enableEncryption: false,
    enableDiffHighlight: true,
    showVersionSize: true,
    enableVersionBranching: true,
    conflictResolution: 'manual',
    autoCleanupDays: 90,
    enableAutoCleanup: false,
    preserveSnapshots: true,
    versionMetadata: true,
    enableVersionNaming: true,
    enableAutoSnapshot: false,
    autoSnapshotInterval: 60,
    enableVersionExport: true,
    comparisonThreshold: 10,
    enableSmartDiff: true,
    showChangePreview: true,
    enableVersionMerge: true,
    maxSearchResults: 50,
    showStatusBar: true,
    autoSaveOnChange: true,
    autoSaveMinChanges: 10,
    sidebarShowPreview: true,
    sidebarMaxVersions: 10,
    sidebarCompactMode: false
};

const SIDEBAR_VIEW_TYPE = 'version-control-sidebar';

class VersionControlPlugin extends Plugin {
    async onload() {
        await this.loadSettings();
        await this.loadVersionData();
        
        this.versionData = this.versionData || {};
        this.autoSaveTimer = null;
        this.modifiedFiles = new Set();
        this.fileWatchers = new Map();
        this.syncQueue = [];
        this.changeLog = [];
        this.versionTags = {};
        this.versionNames = {};
        this.lastSaveTime = {};
        this.changeCounter = {};

        this.statusBarItem = this.addStatusBarItem();
        this.updateStatusBar();

        this.registerView(SIDEBAR_VIEW_TYPE, (leaf) => new VersionControlSidebarView(leaf, this));

        this.addRibbonIcon('archive', 'ÁâàÊú¨ÊéßÂà∂', (evt) => this.showQuickMenu(evt));
        
        this.addCommand({
            id: 'open-version-sidebar',
            name: 'ÊâìÂºÄÁâàÊú¨ÊéßÂà∂‰æßËæπÊ†è',
            callback: () => this.activateSidebar()
        });

        this.registerCommands();
        this.addSettingTab(new VersionControlSettingTab(this.app, this));
        this.registerFileEvents();

        if (this.settings.enableAutoSave) {
            this.startAutoSave();
        }

        if (this.settings.enableAutoCleanup) {
            this.scheduleAutoCleanup();
        }

        if (this.settings.enableAutoSnapshot) {
            this.scheduleAutoSnapshot();
        }

        this.registerEvent(
            this.app.workspace.on('file-menu', (menu, file) => {
                if (file instanceof TFile) {
                    this.addFileContextMenu(menu, file);
                }
            })
        );

        this.registerEvent(
            this.app.workspace.on('editor-menu', (menu, editor, view) => {
                this.addEditorContextMenu(menu, editor, view);
            })
        );

        this.registerEvent(
            this.app.workspace.on('active-leaf-change', () => {
                this.updateSidebar();
            })
        );

        // Ê≥®ÂÜåÂÆöÊó∂‰øùÂ≠ò‰ªªÂä°
        this.registerInterval(
            window.setInterval(() => this.updateStatusBar(), 30000)
        );
    }

    async activateSidebar() {
        const leaf = this.app.workspace.getRightLeaf(false);
        await leaf.setViewState({
            type: SIDEBAR_VIEW_TYPE,
            active: true
        });
        this.app.workspace.revealLeaf(leaf);
    }

    updateSidebar() {
        const view = this.app.workspace.getLeavesOfType(SIDEBAR_VIEW_TYPE)[0];
        if (view && view.view instanceof VersionControlSidebarView) {
            view.view.refresh();
        }
    }

    registerCommands() {
        const commands = [
            {
                id: 'quick-save-version',
                name: 'Âø´ÈÄü‰øùÂ≠òÁâàÊú¨',
                hotkeys: [{ modifiers: ["Ctrl", "Shift"], key: "s" }],
                callback: () => this.quickSaveVersion()
            },
            {
                id: 'save-version',
                name: '‰øùÂ≠òÁâàÊú¨(Â∏¶Â§áÊ≥®)',
                callback: () => this.showSaveVersionModal()
            },
            {
                id: 'view-versions',
                name: 'Êü•ÁúãÁâàÊú¨ÂéÜÂè≤',
                callback: () => this.showVersionListModal()
            },
            {
                id: 'compare-versions',
                name: 'ÊØîËæÉÁâàÊú¨',
                callback: () => this.showCompareModal()
            },
            {
                id: 'export-versions',
                name: 'ÂØºÂá∫ÁâàÊú¨ÂéÜÂè≤',
                callback: () => this.exportVersionHistory()
            },
            {
                id: 'cleanup-versions',
                name: 'Ê∏ÖÁêÜÊóßÁâàÊú¨',
                callback: () => new CleanupModal(this.app, this).open()
            },
            {
                id: 'create-snapshot',
                name: 'ÂàõÂª∫Âø´ÁÖß(‰øùÊä§ÁâàÊú¨)',
                callback: () => this.showSnapshotModal()
            },
            {
                id: 'batch-save',
                name: 'ÊâπÈáè‰øùÂ≠òÊâÄÊúâÊâìÂºÄÊñá‰ª∂ÁöÑÁâàÊú¨',
                callback: () => this.batchSaveOpenFiles()
            },
            {
                id: 'version-stats',
                name: 'Êü•ÁúãÁâàÊú¨ÁªüËÆ°',
                callback: () => new StatsModal(this.app, this).open()
            },
            {
                id: 'search-versions',
                name: 'ÊêúÁ¥¢ÁâàÊú¨ÂÜÖÂÆπ',
                callback: () => new SearchVersionModal(this.app, this).open()
            },
            {
                id: 'version-timeline',
                name: 'Êü•ÁúãÁâàÊú¨Êó∂Èó¥Á∫ø',
                callback: () => new TimelineModal(this.app, this).open()
            },
            {
                id: 'merge-versions',
                name: 'ÂêàÂπ∂ÁâàÊú¨',
                callback: () => this.showMergeModal()
            },
            {
                id: 'tag-version',
                name: '‰∏∫ÂΩìÂâçÁâàÊú¨Ê∑ªÂä†Ê†áÁ≠æ',
                callback: () => this.showTagModal()
            },
            {
                id: 'export-diff-report',
                name: 'ÂØºÂá∫Â∑ÆÂºÇÊä•Âëä',
                callback: () => this.exportDiffReport()
            }
        ];

        commands.forEach(cmd => {
            this.addCommand({
                id: cmd.id,
                name: cmd.name,
                hotkeys: cmd.hotkeys,
                callback: cmd.callback
            });
        });
    }

    async quickSaveVersion() {
        const activeFile = this.app.workspace.getActiveFile();
        if (!activeFile) {
            new Notice('ËØ∑ÂÖàÊâìÂºÄ‰∏Ä‰∏™Êñá‰ª∂');
            return;
        }
        await this.saveVersion(activeFile, 'Âø´ÈÄü‰øùÂ≠ò');
    }

    showSaveVersionModal() {
        const activeFile = this.app.workspace.getActiveFile();
        if (!activeFile) {
            new Notice('ËØ∑ÂÖàÊâìÂºÄ‰∏Ä‰∏™Êñá‰ª∂');
            return;
        }
        new SaveVersionModal(this.app, this, activeFile).open();
    }

    showVersionListModal() {
        const activeFile = this.app.workspace.getActiveFile();
        if (!activeFile) {
            new Notice('ËØ∑ÂÖàÊâìÂºÄ‰∏Ä‰∏™Êñá‰ª∂');
            return;
        }
        new VersionListModal(this.app, this, activeFile).open();
    }

    showCompareModal() {
        const activeFile = this.app.workspace.getActiveFile();
        if (!activeFile) {
            new Notice('ËØ∑ÂÖàÊâìÂºÄ‰∏Ä‰∏™Êñá‰ª∂');
            return;
        }
        new CompareVersionModal(this.app, this, activeFile).open();
    }

    showMergeModal() {
        const activeFile = this.app.workspace.getActiveFile();
        if (!activeFile) {
            new Notice('ËØ∑ÂÖàÊâìÂºÄ‰∏Ä‰∏™Êñá‰ª∂');
            return;
        }
        new MergeVersionModal(this.app, this, activeFile).open();
    }

    showTagModal() {
        const activeFile = this.app.workspace.getActiveFile();
        if (!activeFile) {
            new Notice('ËØ∑ÂÖàÊâìÂºÄ‰∏Ä‰∏™Êñá‰ª∂');
            return;
        }
        new TagVersionModal(this.app, this, activeFile).open();
    }

    async exportVersionHistory() {
        const activeFile = this.app.workspace.getActiveFile();
        if (!activeFile) {
            new Notice('ËØ∑ÂÖàÊâìÂºÄ‰∏Ä‰∏™Êñá‰ª∂');
            return;
        }
        
        const versions = this.getVersions(activeFile);
        if (versions.length === 0) {
            new Notice('ËØ•Êñá‰ª∂Ê≤°ÊúâÁâàÊú¨ÂéÜÂè≤');
            return;
        }

        const exportData = {
            file: activeFile.path,
            exportDate: new Date().toISOString(),
            totalVersions: versions.length,
            versions: versions.map((v, i) => ({
                index: i + 1,
                timestamp: v.timestamp,
                date: new Date(v.timestamp).toLocaleString('zh-CN'),
                comment: v.comment,
                size: v.size,
                hash: v.hash,
                isSnapshot: v.isSnapshot,
                tags: v.tags || [],
                name: this.getVersionName(activeFile.path, i),
                metadata: v.metadata,
                contentPreview: v.content.substring(0, 200)
            }))
        };

        const exportPath = `${activeFile.basename}_ÁâàÊú¨ÂéÜÂè≤_${new Date().toISOString().split('T')[0]}.json`;
        await this.app.vault.create(exportPath, JSON.stringify(exportData, null, 2));
        new Notice(`ÁâàÊú¨ÂéÜÂè≤Â∑≤ÂØºÂá∫Âà∞: ${exportPath}`);
    }

    async exportDiffReport() {
        const activeFile = this.app.workspace.getActiveFile();
        if (!activeFile) {
            new Notice('ËØ∑ÂÖàÊâìÂºÄ‰∏Ä‰∏™Êñá‰ª∂');
            return;
        }

        const versions = this.getVersions(activeFile);
        if (versions.length < 2) {
            new Notice('Ëá≥Â∞ëÈúÄË¶Å‰∏§‰∏™ÁâàÊú¨ÊâçËÉΩÁîüÊàêÂ∑ÆÂºÇÊä•Âëä');
            return;
        }

        let report = `# ÁâàÊú¨Â∑ÆÂºÇÊä•Âëä\n\n`;
        report += `Êñá‰ª∂: ${activeFile.path}\n`;
        report += `ÁîüÊàêÊó∂Èó¥: ${new Date().toLocaleString('zh-CN')}\n`;
        report += `ÊÄªÁâàÊú¨Êï∞: ${versions.length}\n\n`;

        for (let i = 1; i < versions.length; i++) {
            const v1 = versions[i - 1];
            const v2 = versions[i];
            
            report += `## ÁâàÊú¨ ${i} ‚Üí ÁâàÊú¨ ${i + 1}\n\n`;
            report += `- Êó∂Èó¥: ${new Date(v2.timestamp).toLocaleString('zh-CN')}\n`;
            report += `- Â§áÊ≥®: ${v2.comment || 'Êó†'}\n`;
            
            const diff = new DiffEngine(v1.content, v2.content);
            const changes = diff.compute();
            const stats = this.analyzeDiffStats(changes);
            
            report += `- Êñ∞Â¢ûË°åÊï∞: ${stats.added}\n`;
            report += `- Âà†Èô§Ë°åÊï∞: ${stats.removed}\n`;
            report += `- ‰øÆÊîπË°åÊï∞: ${stats.modified}\n\n`;
        }

        const reportPath = `${activeFile.basename}_Â∑ÆÂºÇÊä•Âëä_${new Date().toISOString().split('T')[0]}.md`;
        await this.app.vault.create(reportPath, report);
        new Notice(`Â∑ÆÂºÇÊä•ÂëäÂ∑≤ÂØºÂá∫Âà∞: ${reportPath}`);
    }

    analyzeDiffStats(changes) {
        let added = 0, removed = 0, modified = 0;
        
        changes.forEach(change => {
            if (change.type === 'add') added++;
            else if (change.type === 'remove') removed++;
        });
        
        modified = Math.min(added, removed);
        added -= modified;
        removed -= modified;
        
        return { added, removed, modified };
    }

    showSnapshotModal() {
        const activeFile = this.app.workspace.getActiveFile();
        if (!activeFile) {
            new Notice('ËØ∑ÂÖàÊâìÂºÄ‰∏Ä‰∏™Êñá‰ª∂');
            return;
        }
        new SnapshotModal(this.app, this, activeFile).open();
    }

    registerFileEvents() {
        this.registerEvent(
            this.app.vault.on('modify', async (file) => {
                if (file instanceof TFile && this.settings.enableAutoSave) {
                    this.modifiedFiles.add(file.path);
                    
                    // Â¢ûÂº∫ÁöÑËá™Âä®‰øùÂ≠òÈÄªËæë
                    if (this.settings.autoSaveOnChange) {
                        if (!this.changeCounter[file.path]) {
                            this.changeCounter[file.path] = 0;
                        }
                        this.changeCounter[file.path]++;
                        
                        // ËææÂà∞ÊúÄÂ∞èÂèòÊõ¥Ê¨°Êï∞Êó∂Ëá™Âä®‰øùÂ≠ò
                        if (this.changeCounter[file.path] >= this.settings.autoSaveMinChanges) {
                            await this.saveVersion(file, 'Ëá™Âä®‰øùÂ≠ò (ÂèòÊõ¥Ëß¶Âèë)');
                            this.changeCounter[file.path] = 0;
                            return; // Â∑≤‰øùÂ≠òÔºå‰∏çÈúÄË¶ÅÂÜçËÆæÁΩÆÂÆöÊó∂Âô®
                        }
                    }
                    
                    // ËÆæÁΩÆÂÆöÊó∂Ëá™Âä®‰øùÂ≠ò
                    this.scheduleAutoSave(file);
                    this.updateSidebar();
                }
            })
        );

        this.registerEvent(
            this.app.vault.on('delete', (file) => {
                if (file instanceof TFile && this.settings.enableBackup) {
                    this.backupBeforeDelete(file);
                }
                // Ê∏ÖÁêÜËØ•Êñá‰ª∂ÁöÑÂÆöÊó∂Âô®
                if (this.fileWatchers.has(file.path)) {
                    window.clearTimeout(this.fileWatchers.get(file.path));
                    this.fileWatchers.delete(file.path);
                }
            })
        );

        this.registerEvent(
            this.app.vault.on('rename', (file, oldPath) => {
                if (file instanceof TFile) {
                    this.handleFileRename(file, oldPath);
                    // ËøÅÁßªÂÆöÊó∂Âô®
                    if (this.fileWatchers.has(oldPath)) {
                        const timer = this.fileWatchers.get(oldPath);
                        this.fileWatchers.set(file.path, timer);
                        this.fileWatchers.delete(oldPath);
                    }
                }
            })
        );
    }

    showQuickMenu(evt) {
        const menu = new Menu();
        const activeFile = this.app.workspace.getActiveFile();

        if (activeFile) {
            menu.addItem((item) => {
                item.setTitle('Âø´ÈÄü‰øùÂ≠òÁâàÊú¨').setIcon('save').onClick(() => this.quickSaveVersion());
            });
            menu.addItem((item) => {
                item.setTitle('Êü•ÁúãÁâàÊú¨ÂéÜÂè≤').setIcon('history').onClick(() => this.showVersionListModal());
            });
            menu.addItem((item) => {
                item.setTitle('ÊØîËæÉÁâàÊú¨').setIcon('diff').onClick(() => this.showCompareModal());
            });
            menu.addItem((item) => {
                item.setTitle('ÂàõÂª∫Âø´ÁÖß').setIcon('bookmark').onClick(() => this.showSnapshotModal());
            });
            menu.addSeparator();
        }

        menu.addItem((item) => {
            item.setTitle('ÁâàÊú¨ÁªüËÆ°').setIcon('chart-line').onClick(() => new StatsModal(this.app, this).open());
        });
        menu.addItem((item) => {
            item.setTitle('ÊêúÁ¥¢ÁâàÊú¨').setIcon('search').onClick(() => new SearchVersionModal(this.app, this).open());
        });
        menu.addItem((item) => {
            item.setTitle('ÁâàÊú¨Êó∂Èó¥Á∫ø').setIcon('clock').onClick(() => new TimelineModal(this.app, this).open());
        });
        menu.addItem((item) => {
            item.setTitle('Ê∏ÖÁêÜÊóßÁâàÊú¨').setIcon('trash').onClick(() => new CleanupModal(this.app, this).open());
        });

        menu.showAtMouseEvent(evt);
    }

    addFileContextMenu(menu, file) {
        menu.addSeparator();
        menu.addItem((item) => {
            item.setTitle('‰øùÂ≠òÁâàÊú¨').setIcon('archive').onClick(() => {
                new SaveVersionModal(this.app, this, file).open();
            });
        });
        menu.addItem((item) => {
            item.setTitle('Êü•ÁúãÁâàÊú¨ÂéÜÂè≤').setIcon('history').onClick(() => {
                new VersionListModal(this.app, this, file).open();
            });
        });
        menu.addItem((item) => {
            item.setTitle('ÊØîËæÉÁâàÊú¨').setIcon('diff').onClick(() => {
                new CompareVersionModal(this.app, this, file).open();
            });
        });
    }

    addEditorContextMenu(menu, editor, view) {
        menu.addSeparator();
        menu.addItem((item) => {
            item.setTitle('‰øùÂ≠òÂΩìÂâçÁâàÊú¨').setIcon('save').onClick(() => {
                if (view.file) {
                    this.saveVersion(view.file, 'ÊâãÂä®‰øùÂ≠ò');
                }
            });
        });
        menu.addItem((item) => {
            item.setTitle('Êü•ÁúãÂèòÊõ¥È¢ÑËßà').setIcon('eye').onClick(() => {
                if (view.file) {
                    this.showChangePreview(view.file);
                }
            });
        });
    }

    async showChangePreview(file) {
        const versions = this.getVersions(file);
        if (versions.length === 0) {
            new Notice('Ê≤°ÊúâÂèØÊØîËæÉÁöÑÁâàÊú¨');
            return;
        }

        const currentContent = await this.app.vault.read(file);
        const lastVersion = versions[versions.length - 1];
        
        const diff = new DiffEngine(lastVersion.content, currentContent);
        const changes = diff.compute();
        
        new ChangePreviewModal(this.app, changes).open();
    }

    async saveVersion(file, comment, isSnapshot = false) {
        try {
            const content = await this.app.vault.read(file);
            const hash = this.generateHash(content);
            
            if (!this.versionData[file.path]) {
                this.versionData[file.path] = [];
            }

            const versions = this.versionData[file.path];
            
            if (versions.length > 0 && !isSnapshot) {
                const lastVersion = versions[versions.length - 1];
                if (lastVersion.hash === hash) {
                    if (this.settings.showNotifications) {
                        new Notice('ÂÜÖÂÆπÊú™ÂèòÊõ¥,Êó†ÈúÄ‰øùÂ≠òÊñ∞ÁâàÊú¨');
                    }
                    return false;
                }
            }

            const version = {
                timestamp: Date.now(),
                content: content,
                hash: hash,
                comment: comment || '',
                size: content.length,
                isSnapshot: isSnapshot,
                tags: [],
                author: 'default',
                compressed: false,
                metadata: {
                    lineCount: content.split('\n').length,
                    wordCount: content.split(/\s+/).length,
                    changeType: this.detectChangeType(versions, content),
                    charactersAdded: versions.length > 0 ? Math.max(0, content.length - versions[versions.length - 1].content.length) : content.length,
                    charactersRemoved: versions.length > 0 ? Math.max(0, versions[versions.length - 1].content.length - content.length) : 0
                }
            };

            versions.push(version);
            this.changeLog.push({
                file: file.path,
                action: 'save',
                timestamp: Date.now(),
                versionIndex: versions.length - 1
            });

            if (!isSnapshot && versions.length > this.settings.maxVersions) {
                const nonSnapshots = versions.filter(v => !v.isSnapshot);
                if (nonSnapshots.length > this.settings.maxVersions) {
                    const toRemove = nonSnapshots[0];
                    const index = versions.indexOf(toRemove);
                    if (index > -1) {
                        versions.splice(index, 1);
                    }
                }
            }

            await this.saveVersionData();
            this.modifiedFiles.delete(file.path);
            this.lastSaveTime[file.path] = Date.now();
            this.changeCounter[file.path] = 0;
            this.updateStatusBar();
            this.updateSidebar();
            
            if (this.settings.showNotifications) {
                new Notice(`Â∑≤‰øùÂ≠òÁâàÊú¨ (${versions.length}/${this.settings.maxVersions})`);
            }
            
            return true;
        } catch (error) {
            console.error('‰øùÂ≠òÁâàÊú¨Â§±Ë¥•:', error);
            new Notice('‰øùÂ≠òÁâàÊú¨Â§±Ë¥•: ' + error.message);
            return false;
        }
    }

    detectChangeType(versions, content) {
        if (versions.length === 0) return 'initial';
        
        const lastContent = versions[versions.length - 1].content;
        const sizeDiff = content.length - lastContent.length;
        
        if (sizeDiff > 0) return 'added';
        if (sizeDiff < 0) return 'removed';
        return 'modified';
    }

    async restoreVersion(file, versionIndex) {
        const versions = this.versionData[file.path];
        if (!versions || !versions[versionIndex]) {
            new Notice('ÁâàÊú¨‰∏çÂ≠òÂú®');
            return;
        }

        const version = versions[versionIndex];
        await this.saveVersion(file, `ÊÅ¢Â§çÂâçÂ§á‰ªΩ: ${new Date().toLocaleString('zh-CN')}`);
        await this.app.vault.modify(file, version.content);
        new Notice('ÁâàÊú¨Â∑≤ÊÅ¢Â§ç');
        this.updateSidebar();
    }

    async deleteVersion(file, versionIndex) {
        const versions = this.versionData[file.path];
        if (!versions || !versions[versionIndex]) {
            new Notice('ÁâàÊú¨‰∏çÂ≠òÂú®');
            return;
        }

        versions.splice(versionIndex, 1);
        await this.saveVersionData();
        new Notice('ÁâàÊú¨Â∑≤Âà†Èô§');
        this.updateSidebar();
    }

    getVersions(file) {
        return this.versionData[file.path] || [];
    }

    getAllVersions() {
        return this.versionData;
    }

    getVersionCount() {
        let count = 0;
        for (const filePath in this.versionData) {
            count += this.versionData[filePath].length;
        }
        return count;
    }

    getTotalSize() {
        let size = 0;
        for (const filePath in this.versionData) {
            this.versionData[filePath].forEach(v => {
                size += v.size || 0;
            });
        }
        return size;
    }

    generateHash(content) {
        let hash = 0;
        for (let i = 0; i < content.length; i++) {
            const char = content.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash;
        }
        return hash.toString(36);
    }

    scheduleAutoSave(file) {
        const fileKey = file.path;
        
        // Ê∏ÖÈô§ËØ•Êñá‰ª∂‰πãÂâçÁöÑÂÆöÊó∂Âô®
        if (this.fileWatchers.has(fileKey)) {
            window.clearTimeout(this.fileWatchers.get(fileKey));
        }

        // ËÆæÁΩÆÊñ∞ÁöÑÂÆöÊó∂Âô®
        const timer = window.setTimeout(async () => {
            if (this.modifiedFiles.has(fileKey)) {
                await this.saveVersion(file, 'Ëá™Âä®‰øùÂ≠ò (ÂÆöÊó∂Ëß¶Âèë)');
            }
        }, this.settings.autoSaveInterval * 60 * 1000);
        
        this.fileWatchers.set(fileKey, timer);
    }

    startAutoSave() {
        // Auto-save is triggered by file modification events
    }

    scheduleAutoCleanup() {
        this.registerInterval(
            window.setInterval(() => {
                this.cleanupOldVersions(this.settings.autoCleanupDays);
            }, 24 * 60 * 60 * 1000)
        );
    }

    scheduleAutoSnapshot() {
        this.registerInterval(
            window.setInterval(async () => {
                const activeFile = this.app.workspace.getActiveFile();
                if (activeFile) {
                    await this.saveVersion(activeFile, 'Ëá™Âä®Âø´ÁÖß', true);
                }
            }, this.settings.autoSnapshotInterval * 60 * 1000)
        );
    }

    updateStatusBar() {
        if (this.statusBarItem) {
            if (!this.settings.showStatusBar) {
                this.statusBarItem.setText('');
                this.statusBarItem.style.display = 'none';
                return;
            }
            
            this.statusBarItem.style.display = '';
            const count = this.getVersionCount();
            const size = this.formatSize(this.getTotalSize());
            const modified = this.modifiedFiles.size;
            let text = `üì¶ ${count}‰∏™ÁâàÊú¨ | ${size}`;
            if (modified > 0) text += ` | ‚ö†Ô∏è ${modified}‰∏™ÂæÖ‰øùÂ≠ò`;
            this.statusBarItem.setText(text);
        }
    }

    async batchSaveOpenFiles() {
        const leaves = this.app.workspace.getLeavesOfType('markdown');
        let saved = 0;
        
        for (const leaf of leaves) {
            const view = leaf.view;
            if (view instanceof MarkdownView && view.file) {
                const success = await this.saveVersion(view.file, 'ÊâπÈáè‰øùÂ≠ò');
                if (success) saved++;
            }
        }
        
        new Notice(`Â∑≤‰øùÂ≠ò ${saved} ‰∏™Êñá‰ª∂ÁöÑÁâàÊú¨`);
    }

    async backupBeforeDelete(file) {
        await this.saveVersion(file, 'Âà†Èô§ÂâçÂ§á‰ªΩ', true);
    }

    async handleFileRename(file, oldPath) {
        if (this.versionData[oldPath]) {
            this.versionData[file.path] = this.versionData[oldPath];
            delete this.versionData[oldPath];
            
            if (this.versionNames[oldPath]) {
                this.versionNames[file.path] = this.versionNames[oldPath];
                delete this.versionNames[oldPath];
            }
            
            if (this.versionTags[oldPath]) {
                this.versionTags[file.path] = this.versionTags[oldPath];
                delete this.versionTags[oldPath];
            }
            
            // ËøÅÁßªÁä∂ÊÄÅ
            if (this.lastSaveTime[oldPath]) {
                this.lastSaveTime[file.path] = this.lastSaveTime[oldPath];
                delete this.lastSaveTime[oldPath];
            }
            
            if (this.changeCounter[oldPath]) {
                this.changeCounter[file.path] = this.changeCounter[oldPath];
                delete this.changeCounter[oldPath];
            }
            
            await this.saveVersionData();
        }
    }

    async cleanupOldVersions(daysOld) {
        const cutoffTime = Date.now() - (daysOld * 24 * 60 * 60 * 1000);
        let removed = 0;

        for (const filePath in this.versionData) {
            const versions = this.versionData[filePath];
            const filtered = versions.filter(v => 
                v.isSnapshot || v.timestamp >= cutoffTime
            );
            removed += versions.length - filtered.length;
            this.versionData[filePath] = filtered;
        }

        if (removed > 0) {
            await this.saveVersionData();
        }
        return removed;
    }

    searchInVersions(query) {
        const results = [];
        const maxResults = this.settings.maxSearchResults;
        
        for (const filePath in this.versionData) {
            if (results.length >= maxResults) break;
            
            this.versionData[filePath].forEach((version, index) => {
                if (results.length >= maxResults) return;
                
                if (version.content.toLowerCase().includes(query.toLowerCase()) || 
                    (version.comment && version.comment.toLowerCase().includes(query.toLowerCase()))) {
                    results.push({
                        filePath,
                        versionIndex: index,
                        version,
                        excerpt: this.getExcerpt(version.content, query)
                    });
                }
            });
        }
        
        return results;
    }

    getExcerpt(content, query, length = 100) {
        const index = content.toLowerCase().indexOf(query.toLowerCase());
        if (index === -1) return content.substring(0, length) + '...';
        
        const start = Math.max(0, index - 50);
        const end = Math.min(content.length, index + query.length + 50);
        return '...' + content.substring(start, end) + '...';
    }

    getVersionName(filePath, versionIndex) {
        if (!this.versionNames[filePath]) return null;
        return this.versionNames[filePath][versionIndex] || null;
    }

    setVersionName(filePath, versionIndex, name) {
        if (!this.versionNames[filePath]) {
            this.versionNames[filePath] = {};
        }
        this.versionNames[filePath][versionIndex] = name;
        this.saveVersionData();
    }

    getVersionTags(filePath, versionIndex) {
        if (!this.versionTags[filePath]) return [];
        return this.versionTags[filePath][versionIndex] || [];
    }

    addVersionTag(filePath, versionIndex, tag) {
        if (!this.versionTags[filePath]) {
            this.versionTags[filePath] = {};
        }
        if (!this.versionTags[filePath][versionIndex]) {
            this.versionTags[filePath][versionIndex] = [];
        }
        if (!this.versionTags[filePath][versionIndex].includes(tag)) {
            this.versionTags[filePath][versionIndex].push(tag);
            this.saveVersionData();
        }
    }

    formatSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    async loadSettings() {
        this.settings = Object.assign({}, DEFAULT_SETTINGS, await this.loadData());
    }

    async saveSettings() {
        await this.saveData(this.settings);
    }

    async loadVersionData() {
        const data = await this.loadData();
        this.versionData = (data && data.versionData) ? data.versionData : {};
        this.versionNames = (data && data.versionNames) ? data.versionNames : {};
        this.versionTags = (data && data.versionTags) ? data.versionTags : {};
    }

    async saveVersionData() {
        await this.saveData({ 
            ...this.settings, 
            versionData: this.versionData,
            changeLog: this.changeLog,
            versionNames: this.versionNames,
            versionTags: this.versionTags
        });
    }

    onunload() {
        // Ê∏ÖÁêÜÊâÄÊúâÊñá‰ª∂ÁöÑËá™Âä®‰øùÂ≠òÂÆöÊó∂Âô®
        this.fileWatchers.forEach((timer) => {
            window.clearTimeout(timer);
        });
        this.fileWatchers.clear();
        
        if (this.autoSaveTimer) {
            window.clearTimeout(this.autoSaveTimer);
        }
    }
}

// ‰æßËæπÊ†èËßÜÂõæÁ±ª
class VersionControlSidebarView extends ItemView {
    constructor(leaf, plugin) {
        super(leaf);
        this.plugin = plugin;
        this.activeFile = null;
    }

    getViewType() {
        return SIDEBAR_VIEW_TYPE;
    }

    getDisplayText() {
        return 'ÁâàÊú¨ÊéßÂà∂';
    }

    getIcon() {
        return 'archive';
    }

    async onOpen() {
        this.render();
    }

    refresh() {
        this.render();
    }

    async render() {
        const { containerEl } = this;
        containerEl.empty();

        const activeFile = this.plugin.app.workspace.getActiveFile();
        
        if (!activeFile) {
            containerEl.createEl('div', { cls: 'sidebar-placeholder', text: 'ËØ∑ÊâìÂºÄ‰∏Ä‰∏™Êñá‰ª∂' });
            return;
        }

        this.activeFile = activeFile;

        // ÂàõÂª∫Â§¥ÈÉ®
        this.createHeader(containerEl, activeFile);

        // ÂàõÂª∫Ëá™Âä®‰øùÂ≠òÁä∂ÊÄÅÊåáÁ§∫Âô®
        this.createAutoSaveIndicator(containerEl, activeFile);

        // ÂàõÂª∫Âø´ÈÄüÊìç‰ΩúÊåâÈíÆ
        this.createQuickActions(containerEl, activeFile);

        // ÂàõÂª∫ÊêúÁ¥¢ÂíåÁ≠õÈÄâ
        this.createFilterSection(containerEl, activeFile);

        // ÂàõÂª∫ÁâàÊú¨ÂàóË°®
        this.createVersionList(containerEl, activeFile);

        // ÂàõÂª∫ÁªüËÆ°‰ø°ÊÅØ
        this.createStats(containerEl, activeFile);

        this.addStyles();
    }

    createAutoSaveIndicator(container, file) {
        const indicator = container.createEl('div', { cls: 'auto-save-indicator' });
        
        const status = indicator.createEl('div', { cls: 'indicator-status' });
        
        if (this.plugin.settings.enableAutoSave) {
            const lastSave = this.plugin.lastSaveTime[file.path];
            const changeCount = this.plugin.changeCounter[file.path] || 0;
            
            status.createEl('span', { 
                cls: 'status-icon active',
                text: 'üü¢'
            });
            
            const statusText = status.createEl('span', { cls: 'status-text' });
            
            if (lastSave) {
                const timeSince = Date.now() - lastSave;
                const minutesAgo = Math.floor(timeSince / 60000);
                statusText.setText(`Ëá™Âä®‰øùÂ≠ò: ${minutesAgo > 0 ? minutesAgo + 'ÂàÜÈíüÂâç' : 'ÂàöÂàö'}`);
            } else {
                statusText.setText('Ëá™Âä®‰øùÂ≠ò: Â∑≤ÂêØÁî®');
            }
            
            if (changeCount > 0) {
                indicator.createEl('small', { 
                    cls: 'change-counter',
                    text: `üìù ${changeCount}/${this.plugin.settings.autoSaveMinChanges} Ê¨°ÂèòÊõ¥`
                });
            }
        } else {
            status.createEl('span', { 
                cls: 'status-icon inactive',
                text: '‚ö™'
            });
            status.createEl('span', { 
                cls: 'status-text',
                text: 'Ëá™Âä®‰øùÂ≠ò: Â∑≤Á¶ÅÁî®'
            });
        }
    }

    createFilterSection(container, file) {
        const filterSection = container.createEl('div', { cls: 'sidebar-filter' });
        
        const searchInput = filterSection.createEl('input', {
            type: 'text',
            placeholder: 'üîç ÊêúÁ¥¢ÁâàÊú¨...',
            cls: 'filter-input'
        });
        
        searchInput.addEventListener('input', (e) => {
            this.filterQuery = e.target.value;
            this.createVersionList(container.querySelector('.sidebar-version-list')?.parentElement || container, file);
        });
        
        const filterButtons = filterSection.createEl('div', { cls: 'filter-buttons' });
        
        const btnAll = filterButtons.createEl('button', { 
            text: 'ÂÖ®ÈÉ®',
            cls: 'filter-btn active'
        });
        
        const btnSnapshots = filterButtons.createEl('button', { 
            text: 'Âø´ÁÖß',
            cls: 'filter-btn'
        });
        
        const btnRecent = filterButtons.createEl('button', { 
            text: 'ÊúÄËøë',
            cls: 'filter-btn'
        });
        
        btnAll.addEventListener('click', () => {
            this.filterType = 'all';
            this.updateFilterButtons(filterButtons);
            this.createVersionList(container.querySelector('.sidebar-version-list')?.parentElement || container, file);
        });
        
        btnSnapshots.addEventListener('click', () => {
            this.filterType = 'snapshots';
            this.updateFilterButtons(filterButtons);
            this.createVersionList(container.querySelector('.sidebar-version-list')?.parentElement || container, file);
        });
        
        btnRecent.addEventListener('click', () => {
            this.filterType = 'recent';
            this.updateFilterButtons(filterButtons);
            this.createVersionList(container.querySelector('.sidebar-version-list')?.parentElement || container, file);
        });
    }

    updateFilterButtons(container) {
        container.querySelectorAll('.filter-btn').forEach(btn => {
            btn.removeClass('active');
        });
        
        if (this.filterType === 'all') {
            container.querySelector('.filter-btn:nth-child(1)')?.addClass('active');
        } else if (this.filterType === 'snapshots') {
            container.querySelector('.filter-btn:nth-child(2)')?.addClass('active');
        } else if (this.filterType === 'recent') {
            container.querySelector('.filter-btn:nth-child(3)')?.addClass('active');
        }
    }

    createHeader(container, file) {
        const header = container.createEl('div', { cls: 'sidebar-header' });
        header.createEl('div', { cls: 'sidebar-title', text: 'ÁâàÊú¨ÂéÜÂè≤' });
        header.createEl('small', { cls: 'sidebar-filename', text: file.name });
    }

    createQuickActions(container, file) {
        const actions = container.createEl('div', { cls: 'sidebar-actions' });

        const btnSave = actions.createEl('button', { text: '‰øùÂ≠òÁâàÊú¨', cls: 'sidebar-btn' });
        btnSave.addEventListener('click', () => {
            new SaveVersionModal(this.plugin.app, this.plugin, file).open();
        });

        const btnRestore = actions.createEl('button', { text: 'ÊÅ¢Â§çÁâàÊú¨', cls: 'sidebar-btn' });
        btnRestore.addEventListener('click', () => {
            new VersionListModal(this.plugin.app, this.plugin, file).open();
        });

        const btnCompare = actions.createEl('button', { text: 'ÊØîËæÉ', cls: 'sidebar-btn' });
        btnCompare.addEventListener('click', () => {
            new CompareVersionModal(this.plugin.app, this.plugin, file).open();
        });

        const btnSnapshot = actions.createEl('button', { text: 'Âø´ÁÖß', cls: 'sidebar-btn' });
        btnSnapshot.addEventListener('click', () => {
            new SnapshotModal(this.plugin.app, this.plugin, file).open();
        });
    }

    createVersionList(container, file) {
        // ÁßªÈô§ÊóßÁöÑÁâàÊú¨ÂàóË°®
        const oldList = container.querySelector('.sidebar-version-list');
        if (oldList) oldList.remove();
        
        let versions = this.plugin.getVersions(file);

        if (versions.length === 0) {
            container.createEl('div', { cls: 'sidebar-empty', text: 'ÊöÇÊó†ÁâàÊú¨' });
            return;
        }

        // Â∫îÁî®Á≠õÈÄâ
        if (this.filterType === 'snapshots') {
            versions = versions.filter(v => v.isSnapshot);
        } else if (this.filterType === 'recent') {
            const oneDayAgo = Date.now() - 24 * 60 * 60 * 1000;
            versions = versions.filter(v => v.timestamp > oneDayAgo);
        }
        
        // Â∫îÁî®ÊêúÁ¥¢
        if (this.filterQuery) {
            versions = versions.filter(v => 
                (v.comment && v.comment.toLowerCase().includes(this.filterQuery.toLowerCase())) ||
                new Date(v.timestamp).toLocaleString('zh-CN').includes(this.filterQuery)
            );
        }

        const listContainer = container.createEl('div', { cls: 'sidebar-version-list' });
        listContainer.createEl('div', { 
            cls: 'sidebar-section-title', 
            text: `ÁâàÊú¨ÂàóË°® (${versions.length}/${this.plugin.getVersions(file).length})` 
        });

        const list = listContainer.createEl('div', { cls: 'version-items' });

        // ÊòæÁ§∫ÁâàÊú¨Êï∞ÈáèÊ†πÊçÆËÆæÁΩÆ
        const maxShow = this.plugin.settings.sidebarCompactMode ? 5 : this.plugin.settings.sidebarMaxVersions;
        const displayVersions = versions.slice(-maxShow).reverse();

        displayVersions.forEach((version, idx) => {
            const allVersions = this.plugin.getVersions(file);
            const actualIndex = allVersions.indexOf(version);
            const item = list.createEl('div', { cls: 'sidebar-version-item' });
            
            if (this.plugin.settings.sidebarCompactMode) {
                item.addClass('compact');
            }
            
            const badge = version.isSnapshot ? 'üìå' : 'üìÑ';
            const date = new Date(version.timestamp);
            const timeStr = date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            const dateStr = date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });

            const headerRow = item.createEl('div', { cls: 'item-header-row' });
            headerRow.createEl('div', { cls: 'item-header', text: `${badge} v${actualIndex + 1}` });
            headerRow.createEl('small', { cls: 'item-time', text: `${dateStr} ${timeStr}` });

            if (version.comment && !this.plugin.settings.sidebarCompactMode) {
                item.createEl('small', { cls: 'item-comment', text: version.comment });
            }

            // ÊòæÁ§∫ÁâàÊú¨ÂêçÁß∞
            const versionName = this.plugin.getVersionName(file.path, actualIndex);
            if (versionName) {
                item.createEl('small', { cls: 'item-name', text: `üè∑Ô∏è ${versionName}` });
            }

            // ÊòæÁ§∫Ê†áÁ≠æ
            const tags = this.plugin.getVersionTags(file.path, actualIndex);
            if (tags.length > 0 && !this.plugin.settings.sidebarCompactMode) {
                const tagContainer = item.createEl('div', { cls: 'item-tags' });
                tags.slice(0, 3).forEach(tag => {
                    tagContainer.createEl('span', { cls: 'tag-badge', text: tag });
                });
                if (tags.length > 3) {
                    tagContainer.createEl('span', { cls: 'tag-badge more', text: `+${tags.length - 3}` });
                }
            }

            // ÊòæÁ§∫È¢ÑËßà
            if (this.plugin.settings.sidebarShowPreview && !this.plugin.settings.sidebarCompactMode) {
                const preview = version.content.substring(0, 60).replace(/\n/g, ' ');
                item.createEl('small', { cls: 'item-preview', text: preview + '...' });
            }

            const metaRow = item.createEl('div', { cls: 'item-meta-row' });
            metaRow.createEl('small', { cls: 'item-size', text: this.plugin.formatSize(version.size) });
            
            if (version.metadata && !this.plugin.settings.sidebarCompactMode) {
                const changeIcons = {
                    'initial': 'üÜï',
                    'added': '‚ûï',
                    'removed': '‚ûñ',
                    'modified': '‚úèÔ∏è'
                };
                const changeIcon = changeIcons[version.metadata.changeType] || 'üìù';
                metaRow.createEl('small', { 
                    cls: 'item-change-type', 
                    text: `${changeIcon} ${version.metadata.lineCount}Ë°å`
                });
            }

            const itemActions = item.createEl('div', { cls: 'item-actions' });

            const restoreBtn = itemActions.createEl('button', { text: 'ËøòÂéü', cls: 'action-btn' });
            restoreBtn.addEventListener('click', async () => {
                await this.plugin.restoreVersion(file, actualIndex);
                this.refresh();
            });

            const viewBtn = itemActions.createEl('button', { text: 'Êü•Áúã', cls: 'action-btn' });
            viewBtn.addEventListener('click', () => {
                new ViewVersionModal(this.plugin.app, version).open();
            });
            
            if (!this.plugin.settings.sidebarCompactMode) {
                const compareBtn = itemActions.createEl('button', { text: 'ÂØπÊØî', cls: 'action-btn' });
                compareBtn.addEventListener('click', () => {
                    new CompareVersionModal(this.plugin.app, this.plugin, file).open();
                });
            }
        });
        
        // Â¶ÇÊûúÊúâÊõ¥Â§öÁâàÊú¨,ÊòæÁ§∫ÊèêÁ§∫
        if (versions.length > maxShow) {
            const moreHint = listContainer.createEl('div', { 
                cls: 'more-versions-hint',
                text: `ËøòÊúâ ${versions.length - maxShow} ‰∏™ÁâàÊú¨...`
            });
            moreHint.addEventListener('click', () => {
                new VersionListModal(this.plugin.app, this.plugin, file).open();
            });
        }
    }

    createStats(container, file) {
        const versions = this.plugin.getVersions(file);
        if (versions.length === 0) return;

        const stats = container.createEl('div', { cls: 'sidebar-stats' });
        stats.createEl('div', { cls: 'sidebar-section-title', text: 'ÁªüËÆ°‰ø°ÊÅØ' });

        let totalSize = 0;
        let snapshotCount = 0;
        let maxVersion = null;

        versions.forEach(v => {
            totalSize += v.size || 0;
            if (v.isSnapshot) snapshotCount++;
            if (!maxVersion || v.size > maxVersion.size) maxVersion = v;
        });

        const statsGrid = stats.createEl('div', { cls: 'stats-grid' });

        this.createStatItem(statsGrid, 'ÊÄªÁâàÊú¨Êï∞', versions.length.toString());
        this.createStatItem(statsGrid, 'Âø´ÁÖßÊï∞', snapshotCount.toString());
        this.createStatItem(statsGrid, 'ÊÄªÂ§ßÂ∞è', this.plugin.formatSize(totalSize));
        this.createStatItem(statsGrid, 'ÊúÄÂ§ßÁâàÊú¨', this.plugin.formatSize(maxVersion?.size || 0));
    }

    createStatItem(container, label, value) {
        const item = container.createEl('div', { cls: 'stat-box' });
        item.createEl('div', { cls: 'stat-label', text: label });
        item.createEl('div', { cls: 'stat-value', text: value });
    }

    addStyles() {
        const style = this.containerEl.createEl('style');
        style.textContent = `
            .sidebar-placeholder {
                padding: 1.5em;
                text-align: center;
                color: var(--text-muted);
            }

            .sidebar-header {
                padding: 1em;
                border-bottom: 1px solid var(--background-modifier-border);
            }

            .sidebar-title {
                font-weight: bold;
                font-size: 1em;
                margin-bottom: 0.3em;
            }

            .sidebar-filename {
                color: var(--text-muted);
                font-size: 0.85em;
                word-break: break-all;
            }

            .sidebar-actions {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 0.5em;
                padding: 0.8em;
                border-bottom: 1px solid var(--background-modifier-border);
            }

            .sidebar-btn {
                padding: 0.6em;
                font-size: 0.85em;
                border: 1px solid var(--background-modifier-border);
                border-radius: 4px;
                background: var(--background-primary);
                cursor: pointer;
                transition: all 0.2s ease;
                min-height: 36px;
            }

            .sidebar-btn:hover {
                background: var(--background-secondary);
            }

            .sidebar-btn:active {
                transform: scale(0.95);
            }

            .sidebar-version-list {
                padding: 0.8em;
                border-bottom: 1px solid var(--background-modifier-border);
            }

            .sidebar-section-title {
                font-weight: bold;
                font-size: 0.9em;
                margin-bottom: 0.8em;
                color: var(--text-normal);
            }

            .version-items {
                display: flex;
                flex-direction: column;
                gap: 0.5em;
                max-height: 300px;
                overflow-y: auto;
            }

            .sidebar-version-item {
                padding: 0.8em;
                border: 1px solid var(--background-modifier-border);
                border-radius: 4px;
                background: var(--background-primary);
                transition: all 0.2s ease;
            }

            .sidebar-version-item:hover {
                background: var(--background-secondary);
                border-color: var(--interactive-accent);
            }

            .item-header {
                font-weight: bold;
                font-size: 0.9em;
                margin-bottom: 0.3em;
            }

            .item-time,
            .item-comment,
            .item-name,
            .item-size {
                display: block;
                color: var(--text-muted);
                font-size: 0.8em;
                margin-bottom: 0.2em;
            }

            .item-comment {
                color: var(--text-accent);
                font-style: italic;
                margin-top: 0.3em;
            }

            .item-name {
                color: var(--text-success);
            }

            .item-tags {
                display: flex;
                flex-wrap: wrap;
                gap: 0.3em;
                margin: 0.3em 0;
            }

            .tag-badge {
                font-size: 0.7em;
                padding: 0.2em 0.5em;
                background: var(--interactive-accent);
                color: var(--text-on-accent);
                border-radius: 3px;
            }

            .item-actions {
                display: flex;
                gap: 0.3em;
                margin-top: 0.5em;
            }

            .action-btn {
                flex: 1;
                padding: 0.4em;
                font-size: 0.75em;
                border: 1px solid var(--interactive-accent);
                border-radius: 3px;
                background: transparent;
                color: var(--interactive-accent);
                cursor: pointer;
                transition: all 0.2s ease;
                min-height: 28px;
            }

            .action-btn:hover {
                background: var(--interactive-accent);
                color: var(--text-on-accent);
            }

            .action-btn:active {
                transform: scale(0.95);
            }

            .sidebar-stats {
                padding: 0.8em;
            }

            .stats-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 0.6em;
            }

            .stat-box {
                padding: 0.8em;
                background: var(--background-secondary);
                border-radius: 4px;
                border: 1px solid var(--background-modifier-border);
                text-align: center;
            }

            .stat-label {
                font-size: 0.8em;
                color: var(--text-muted);
                margin-bottom: 0.3em;
            }

            .stat-value {
                font-size: 0.95em;
                font-weight: bold;
                color: var(--text-accent);
            }

            .sidebar-empty {
                padding: 1.5em;
                text-align: center;
                color: var(--text-muted);
                font-size: 0.9em;
            }
        `;
    }

    onClose() {
        const { containerEl } = this;
        containerEl.empty();
    }
}

// Modal Classes
class SaveVersionModal extends Modal {
    constructor(app, plugin, file) {
        super(app);
        this.plugin = plugin;
        this.file = file;
        this.comment = '';
        this.tags = [];
        this.versionName = '';
    }

    onOpen() {
        const { contentEl } = this;
        contentEl.empty();

        contentEl.createEl('h2', { text: '‰øùÂ≠òÁâàÊú¨' });
        contentEl.createEl('p', { text: `Êñá‰ª∂: ${this.file.name}` });

        new Setting(contentEl)
            .setName('ÁâàÊú¨Â§áÊ≥®')
            .setDesc('‰∏∫Ê≠§ÁâàÊú¨Ê∑ªÂä†ËØ¥Êòé')
            .addText(text => text
                .setPlaceholder('‰æãÂ¶Ç:‰øÆÂ§ç‰∫ÜÊ†ºÂºèÈóÆÈ¢ò')
                .onChange(value => { this.comment = value; }));

        if (this.plugin.settings.enableVersionNaming) {
            new Setting(contentEl)
                .setName('ÁâàÊú¨ÂêçÁß∞')
                .setDesc('‰∏∫ÁâàÊú¨ËÆæÁΩÆ‰∏Ä‰∏™ÊòìËÆ∞ÁöÑÂêçÁß∞')
                .addText(text => text
                    .setPlaceholder('‰æãÂ¶Ç:Á®≥ÂÆöÁâà 1.0')
                    .onChange(value => { this.versionName = value; }));
        }

        if (this.plugin.settings.enableTags) {
            new Setting(contentEl)
                .setName('Ê†áÁ≠æ')
                .setDesc('Ê∑ªÂä†Ê†áÁ≠æ(Áî®ÈÄóÂè∑ÂàÜÈöî)')
                .addText(text => text
                    .setPlaceholder('‰æãÂ¶Ç:ÈáçË¶Å, ‰øÆÂ§ç, ÂäüËÉΩ')
                    .onChange(value => {
                        this.tags = value.split(',').map(t => t.trim()).filter(t => t);
                    }));
        }

        new Setting(contentEl)
            .addButton(btn => btn.setButtonText('‰øùÂ≠ò').setCta().onClick(async () => {
                const success = await this.plugin.saveVersion(this.file, this.comment);
                if (success && this.versionName) {
                    const versions = this.plugin.getVersions(this.file);
                    this.plugin.setVersionName(this.file.path, versions.length - 1, this.versionName);
                }
                if (success && this.tags.length > 0) {
                    const versions = this.plugin.getVersions(this.file);
                    this.tags.forEach(tag => {
                        this.plugin.addVersionTag(this.file.path, versions.length - 1, tag);
                    });
                }
                this.close();
            }))
            .addButton(btn => btn.setButtonText('‰øùÂ≠ò‰∏∫Âø´ÁÖß').onClick(async () => {
                const success = await this.plugin.saveVersion(this.file, this.comment, true);
                if (success && this.versionName) {
                    const versions = this.plugin.getVersions(this.file);
                    this.plugin.setVersionName(this.file.path, versions.length - 1, this.versionName);
                }
                this.close();
            }))
            .addButton(btn => btn.setButtonText('ÂèñÊ∂à').onClick(() => this.close()));
    }

    onClose() {
        const { contentEl } = this;
        contentEl.empty();
    }
}

class VersionListModal extends Modal {
    constructor(app, plugin, file) {
        super(app);
        this.plugin = plugin;
        this.file = file;
        this.filterText = '';
        this.sortBy = 'date';
        this.filterTag = '';
    }

    onOpen() {
        this.render();
    }

    render() {
        const { contentEl } = this;
        contentEl.empty();

        contentEl.createEl('h2', { text: 'ÁâàÊú¨ÂéÜÂè≤' });
        contentEl.createEl('p', { text: `Êñá‰ª∂: ${this.file.name}` });

        const toolbar = contentEl.createEl('div', { cls: 'version-toolbar' });
        
        new Setting(toolbar)
            .setName('ÊêúÁ¥¢')
            .addText(text => text
                .setPlaceholder('ÊêúÁ¥¢Â§áÊ≥®...')
                .onChange(value => {
                    this.filterText = value;
                    this.renderVersions();
                }));

        new Setting(toolbar)
            .setName('Á≠õÈÄâÊ†áÁ≠æ')
            .addText(text => text
                .setPlaceholder('ËæìÂÖ•Ê†áÁ≠æ...')
                .onChange(value => {
                    this.filterTag = value;
                    this.renderVersions();
                }));

        new Setting(toolbar)
            .setName('ÊéíÂ∫è')
            .addDropdown(dropdown => dropdown
                .addOption('date', 'ÊåâÊó•Êúü')
                .addOption('size', 'ÊåâÂ§ßÂ∞è')
                .addOption('comment', 'ÊåâÂ§áÊ≥®')
                .setValue(this.sortBy)
                .onChange(value => {
                    this.sortBy = value;
                    this.renderVersions();
                }));

        this.versionContainer = contentEl.createEl('div', { cls: 'version-container' });
        this.renderVersions();
    }

    renderVersions() {
        this.versionContainer.empty();

        let versions = this.plugin.getVersions(this.file);

        if (versions.length === 0) {
            this.versionContainer.createEl('p', { text: 'ÊöÇÊó†ÁâàÊú¨ÂéÜÂè≤' });
            return;
        }

        if (this.filterText) {
            versions = versions.filter(v => 
                (v.comment && v.comment.toLowerCase().includes(this.filterText.toLowerCase()))
            );
        }

        if (this.filterTag) {
            versions = versions.filter((v, idx) => {
                const tags = this.plugin.getVersionTags(this.file.path, idx);
                return tags.some(tag => tag.toLowerCase().includes(this.filterTag.toLowerCase()));
            });
        }

        versions = [...versions];
        if (this.sortBy === 'date') {
            versions.sort((a, b) => b.timestamp - a.timestamp);
        } else if (this.sortBy === 'size') {
            versions.sort((a, b) => (b.size || 0) - (a.size || 0));
        } else if (this.sortBy === 'comment') {
            versions.sort((a, b) => (a.comment || '').localeCompare(b.comment || ''));
        }

        const listEl = this.versionContainer.createEl('div', { cls: 'version-list' });

        versions.forEach((version) => {
            const actualIndex = this.plugin.getVersions(this.file).indexOf(version);
            this.renderVersionItem(listEl, version, actualIndex);
        });
    }

    renderVersionItem(container, version, actualIndex) {
        const versionEl = container.createEl('div', { cls: 'version-item' });
        
        if (version.isSnapshot) {
            versionEl.addClass('version-snapshot');
        }

        const date = new Date(version.timestamp);
        const dateStr = date.toLocaleString('zh-CN');
        const sizeStr = this.plugin.formatSize(version.size || 0);
        
        const headerEl = versionEl.createEl('div', { cls: 'version-header' });
        headerEl.createEl('span', { 
            text: `${version.isSnapshot ? 'üìå ' : ''}ÁâàÊú¨ ${actualIndex + 1}`,
            cls: 'version-title'
        });
        headerEl.createEl('span', { 
            text: dateStr,
            cls: 'version-date'
        });
        headerEl.createEl('span', { 
            text: sizeStr,
            cls: 'version-size'
        });

        const versionName = this.plugin.getVersionName(this.file.path, actualIndex);
        if (versionName) {
            versionEl.createEl('div', { 
                text: `üè∑Ô∏è ${versionName}`,
                cls: 'version-name'
            });
        }
        
        if (version.comment) {
            versionEl.createEl('div', { 
                text: `üí¨ ${version.comment}`,
                cls: 'version-comment'
            });
        }

        const tags = this.plugin.getVersionTags(this.file.path, actualIndex);
        if (tags.length > 0) {
            const tagContainer = versionEl.createEl('div', { cls: 'version-tags' });
            tags.forEach(tag => {
                tagContainer.createEl('span', { cls: 'tag-badge', text: tag });
            });
        }

        if (version.metadata) {
            const metaEl = versionEl.createEl('div', { cls: 'version-metadata' });
            metaEl.createEl('small', { 
                text: `üìù ${version.metadata.lineCount} Ë°å | üìä ${version.metadata.wordCount} ËØç`,
                cls: 'metadata-info'
            });
            if (version.metadata.changeType) {
                const changeTypes = {
                    'initial': 'üÜï ÂàùÂßãÁâàÊú¨',
                    'added': '‚ûï Êñ∞Â¢ûÂÜÖÂÆπ',
                    'removed': '‚ûñ Âà†Èô§ÂÜÖÂÆπ',
                    'modified': '‚úèÔ∏è ‰øÆÊîπÂÜÖÂÆπ'
                };
                metaEl.createEl('small', { 
                    text: changeTypes[version.metadata.changeType],
                    cls: 'change-type'
                });
            }
        }

        const btnContainer = versionEl.createEl('div', { cls: 'version-buttons' });
        
        btnContainer.createEl('button', { text: 'üìÑ ÊÅ¢Â§ç' }).addEventListener('click', () => {
            this.plugin.restoreVersion(this.file, actualIndex);
            this.close();
        });

        btnContainer.createEl('button', { text: 'üëÅÔ∏è Êü•Áúã' }).addEventListener('click', () => {
            new ViewVersionModal(this.plugin.app, version).open();
        });

        btnContainer.createEl('button', { text: 'üóëÔ∏è Âà†Èô§', cls: 'mod-warning' }).addEventListener('click', () => {
            if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™ÁâàÊú¨Âêó?')) {
                this.plugin.deleteVersion(this.file, actualIndex);
                this.render();
            }
        });
    }

    onClose() {
        const { contentEl } = this;
        contentEl.empty();
    }
}

class ViewVersionModal extends Modal {
    constructor(app, version) {
        super(app);
        this.version = version;
    }

    onOpen() {
        const { contentEl } = this;
        contentEl.empty();

        const date = new Date(this.version.timestamp);
        contentEl.createEl('h2', { text: `ÁâàÊú¨ÂÜÖÂÆπ - ${date.toLocaleString('zh-CN')}` });

        const preEl = contentEl.createEl('pre', { cls: 'version-content' });
        preEl.textContent = this.version.content;

        contentEl.createEl('button', { text: 'üìã Â§çÂà∂ÂÜÖÂÆπ' }).addEventListener('click', () => {
            navigator.clipboard.writeText(this.version.content);
            new Notice('Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø');
        });
    }

    onClose() {
        const { contentEl } = this;
        contentEl.empty();
    }
}

// DiffÁÆóÊ≥ïÂºïÊìé
class DiffEngine {
    constructor(content1, content2, ignoreWhitespace = false) {
        if (ignoreWhitespace) {
            this.lines1 = content1.split('\n').map(line => line.trim());
            this.lines2 = content2.split('\n').map(line => line.trim());
        } else {
            this.lines1 = content1.split('\n');
            this.lines2 = content2.split('\n');
        }
        this.ignoreWhitespace = ignoreWhitespace;
    }

    compute() {
        const changes = [];
        let i = 0, j = 0;
        
        while (i < this.lines1.length || j < this.lines2.length) {
            if (i < this.lines1.length && j < this.lines2.length && this.lines1[i] === this.lines2[j]) {
                changes.push({ type: 'context', content: this.lines1[i], line1: i + 1, line2: j + 1 });
                i++;
                j++;
            } else if (j >= this.lines2.length || (i < this.lines1.length && this.shouldRemove(i, j))) {
                changes.push({ type: 'remove', content: this.lines1[i], line1: i + 1 });
                i++;
            } else {
                changes.push({ type: 'add', content: this.lines2[j], line2: j + 1 });
                j++;
            }
        }
        
        return changes;
    }

    shouldRemove(i, j) {
        return i < this.lines1.length && 
               (j >= this.lines2.length || this.lines1[i] !== this.lines2[j]);
    }
}

// Â¢ûÂº∫ÁöÑÊØîËæÉÁâàÊú¨Modal
class CompareVersionModal extends Modal {
    constructor(app, plugin, file) {
        super(app);
        this.plugin = plugin;
        this.file = file;
        this.diffMode = 'unified';
        this.showOnlyChanges = false;
        this.ignoreWhitespace = false;
        this.contextLines = 3;
        this.version1Index = 0;
        this.version2Index = 0;
        this.versions = [];
    }

    onOpen() {
        const { contentEl } = this;
        contentEl.empty();
        
        // ËÆæÁΩÆ Modal ÂÆπÂô®ÁöÑÊ†∑Âºè
        contentEl.style.cssText = 'max-height: 80vh; overflow-y: auto; padding: 20px;';

        contentEl.createEl('h2', { text: 'üìä ÊØîËæÉÁâàÊú¨' });
        
        this.versions = this.plugin.getVersions(this.file);
        
        if (this.versions.length < 2) {
            contentEl.createEl('p', { text: 'Ëá≥Â∞ëÈúÄË¶Å‰∏§‰∏™ÁâàÊú¨ÊâçËÉΩÊØîËæÉ' });
            return;
        }

        this.version1Index = this.versions.length > 1 ? this.versions.length - 2 : 0;
        this.version2Index = this.versions.length - 1;

        const controls = contentEl.createEl('div', { cls: 'diff-controls' });
        controls.style.marginBottom = '20px';

        // ÁâàÊú¨ÈÄâÊã©Âô®
        const versionSelectors = controls.createEl('div', { cls: 'version-selectors' });

        new Setting(versionSelectors)
            .setName('Âü∫Á°ÄÁâàÊú¨')
            .setDesc('ÈÄâÊã©Ë¶ÅÂØπÊØîÁöÑÊóßÁâàÊú¨')
            .addDropdown(dropdown => {
                this.versions.forEach((v, i) => {
                    const date = new Date(v.timestamp).toLocaleString('zh-CN', {
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    const name = this.plugin.getVersionName(this.file.path, i);
                    const label = name ? `${name} (${date})` : `ÁâàÊú¨ ${i + 1} - ${date}`;
                    const snapshot = v.isSnapshot ? ' üìå' : '';
                    dropdown.addOption(i.toString(), label + snapshot);
                });
                dropdown.setValue(this.version1Index.toString());
                dropdown.onChange(value => { 
                    this.version1Index = parseInt(value);
                });
            });

        new Setting(versionSelectors)
            .setName('ÂØπÊØîÁâàÊú¨')
            .setDesc('ÈÄâÊã©Ë¶ÅÂØπÊØîÁöÑÊñ∞ÁâàÊú¨')
            .addDropdown(dropdown => {
                this.versions.forEach((v, i) => {
                    const date = new Date(v.timestamp).toLocaleString('zh-CN', {
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    const name = this.plugin.getVersionName(this.file.path, i);
                    const label = name ? `${name} (${date})` : `ÁâàÊú¨ ${i + 1} - ${date}`;
                    const snapshot = v.isSnapshot ? ' üìå' : '';
                    dropdown.addOption(i.toString(), label + snapshot);
                });
                dropdown.setValue(this.version2Index.toString());
                dropdown.onChange(value => { 
                    this.version2Index = parseInt(value);
                });
            });

        // Âø´ÈÄüÈÄâÊã©ÊåâÈíÆ
        const quickSelect = controls.createEl('div', { cls: 'quick-select' });
        quickSelect.createEl('span', { text: 'Âø´ÈÄüÈÄâÊã©: ', cls: 'quick-label' });
        
        const btnLatest = quickSelect.createEl('button', { text: 'ÊúÄÊñ∞‰∏§Áâà', cls: 'quick-btn' });
        btnLatest.addEventListener('click', () => {
            this.version1Index = Math.max(0, this.versions.length - 2);
            this.version2Index = this.versions.length - 1;
            this.updateDropdowns(versionSelectors);
            this.showDiff(this.versions[this.version1Index], this.versions[this.version2Index]);
        });

        const btnFirstLast = quickSelect.createEl('button', { text: 'È¶ñÁâà‰∏éÊú´Áâà', cls: 'quick-btn' });
        btnFirstLast.addEventListener('click', () => {
            this.version1Index = 0;
            this.version2Index = this.versions.length - 1;
            this.updateDropdowns(versionSelectors);
            this.showDiff(this.versions[this.version1Index], this.versions[this.version2Index]);
        });

        const btnSnapshots = quickSelect.createEl('button', { text: 'Âø´ÁÖßÂØπÊØî', cls: 'quick-btn' });
        btnSnapshots.addEventListener('click', () => {
            const snapshots = this.versions.map((v, i) => ({v, i})).filter(item => item.v.isSnapshot);
            if (snapshots.length >= 2) {
                this.version1Index = snapshots[snapshots.length - 2].i;
                this.version2Index = snapshots[snapshots.length - 1].i;
                this.updateDropdowns(versionSelectors);
                this.showDiff(this.versions[this.version1Index], this.versions[this.version2Index]);
            } else {
                new Notice('Âø´ÁÖßÁâàÊú¨‰∏çË∂≥‰∏§‰∏™');
            }
        });

        // ÂØπÊØîÈÄâÈ°π
        const options = controls.createEl('div', { cls: 'diff-options' });

        new Setting(options)
            .setName('ÊòæÁ§∫Ê®°Âºè')
            .addDropdown(dropdown => dropdown
                .addOption('unified', 'Áªü‰∏ÄËßÜÂõæ')
                .addOption('split', 'ÂàÜÂ±èËßÜÂõæ')
                .addOption('inline', 'Ë°åÂÜÖÈ´ò‰∫Æ')
                .setValue(this.diffMode)
                .onChange(value => { this.diffMode = value; }));

        new Setting(options)
            .setName('Âè™ÊòæÁ§∫ÂèòÊõ¥')
            .setDesc('ÈöêËóèÊú™ÊîπÂèòÁöÑÂÜÖÂÆπ')
            .addToggle(toggle => toggle
                .setValue(this.showOnlyChanges)
                .onChange(value => { this.showOnlyChanges = value; }));

        new Setting(options)
            .setName('ÂøΩÁï•Á©∫ÁôΩ')
            .setDesc('ÂøΩÁï•Á©∫Ê†ºÂíåÊç¢Ë°åÁöÑÂ∑ÆÂºÇ')
            .addToggle(toggle => toggle
                .setValue(this.ignoreWhitespace)
                .onChange(value => { this.ignoreWhitespace = value; }));

        new Setting(options)
            .setName('‰∏ä‰∏ãÊñáË°åÊï∞')
            .setDesc('ÊòæÁ§∫ÂèòÊõ¥Âë®Âõ¥ÁöÑË°åÊï∞')
            .addSlider(slider => slider
                .setLimits(0, 10, 1)
                .setValue(this.contextLines)
                .setDynamicTooltip()
                .onChange(value => { this.contextLines = value; }));

        // Êìç‰ΩúÊåâÈíÆ
        const actions = controls.createEl('div', { cls: 'diff-actions' });
        actions.style.display = 'flex';
        actions.style.gap = '10px';
        actions.style.marginTop = '15px';
        
        const compareBtn = actions.createEl('button', { 
            text: 'üîç ÂºÄÂßãÂØπÊØî',
            cls: 'mod-cta'
        });
        compareBtn.style.flex = '1';
        compareBtn.addEventListener('click', () => {
            try {
                console.log('ÁÇπÂáªÂØπÊØîÊåâÈíÆ');
                console.log('ÁâàÊú¨Á¥¢Âºï:', this.version1Index, this.version2Index);
                
                if (this.version1Index === this.version2Index) {
                    new Notice('ËØ∑ÈÄâÊã©‰∏çÂêåÁöÑÁâàÊú¨');
                    return;
                }
                
                const v1 = this.versions[this.version1Index];
                const v2 = this.versions[this.version2Index];
                
                if (!v1 || !v2) {
                    new Notice('ÁâàÊú¨Êï∞ÊçÆËé∑ÂèñÂ§±Ë¥•');
                    return;
                }
                
                this.showDiff(v1, v2);
            } catch (error) {
                console.error('ÂØπÊØîÊåâÈíÆÁÇπÂáªÈîôËØØ:', error);
                new Notice('ÂØπÊØîÂ§±Ë¥•: ' + error.message);
            }
        });
        
        const copyBtn = actions.createEl('button', { text: 'üìã Â§çÂà∂' });
        copyBtn.style.flex = '1';
        copyBtn.addEventListener('click', () => {
            if (!this.currentDiff) {
                new Notice('ËØ∑ÂÖàËøõË°åÂØπÊØî');
                return;
            }
            this.copyDiffToClipboard();
        });
        
        const exportBtn = actions.createEl('button', { text: 'üíæ ÂØºÂá∫' });
        exportBtn.style.flex = '1';
        exportBtn.addEventListener('click', () => {
            if (!this.currentDiff) {
                new Notice('ËØ∑ÂÖàËøõË°åÂØπÊØî');
                return;
            }
            this.exportDiffReport(this.versions[this.version1Index], this.versions[this.version2Index]);
        });

        // ÂØπÊØîÁªìÊûúÂÆπÂô® - ÂÖ≥ÈîÆÔºö‰∏çÂµåÂ•óÂú® controls ÈáåÈù¢
        this.diffContainer = contentEl.createEl('div', { cls: 'diff-container' });
        this.diffContainer.style.cssText = 'margin-top: 20px; width: 100%; min-height: 300px;';
        
        // Ëá™Âä®ÊòæÁ§∫ÊúÄÊñ∞‰∏§‰∏™ÁâàÊú¨ÁöÑÂØπÊØî
        try {
            console.log('Ëá™Âä®ÊòæÁ§∫ÂØπÊØî');
            this.showDiff(this.versions[this.version1Index], this.versions[this.version2Index]);
        } catch (error) {
            console.error('Ëá™Âä®ÂØπÊØîÂ§±Ë¥•:', error);
            const notice = this.diffContainer.createEl('div');
            notice.style.cssText = 'padding: 20px; background: #ffeecc; border: 2px solid #ff9900; border-radius: 4px;';
            notice.textContent = 'Ëá™Âä®ÂØπÊØîÂ§±Ë¥•ÔºåËØ∑ÁÇπÂáª"ÂºÄÂßãÂØπÊØî"ÊåâÈíÆ';
        }
    }

    updateDropdowns(container) {
        const dropdowns = container.querySelectorAll('select');
        if (dropdowns[0]) dropdowns[0].value = this.version1Index.toString();
        if (dropdowns[1]) dropdowns[1].value = this.version2Index.toString();
    }

    showDiff(v1, v2) {
        try {
            console.log('ÂºÄÂßãÂØπÊØîÁâàÊú¨:', v1, v2);
            
            if (!v1 || !v2) {
                new Notice('ÁâàÊú¨Êï∞ÊçÆÊó†Êïà');
                return;
            }
            
            // Ê∏ÖÁ©∫ÂÆπÂô®
            this.diffContainer.empty();
            console.log('Â∑≤Ê∏ÖÁ©∫ÂÆπÂô®');
            
            this.currentDiff = { v1, v2 };

            const diff = new DiffEngine(v1.content, v2.content, this.ignoreWhitespace);
            let changes = diff.compute();
            
            console.log('ËÆ°ÁÆóÂá∫ÁöÑÂèòÊõ¥Êï∞Èáè:', changes.length);

            // Â∫îÁî®ËøáÊª§
            if (this.showOnlyChanges) {
                changes = this.filterChanges(changes);
            }

            // ÁæéÂåñÁöÑÁªüËÆ°‰ø°ÊÅØ
            const statsDiv = this.diffContainer.createEl('div');
            statsDiv.style.cssText = `
                padding: 20px;
                margin: 15px 0;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                border-radius: 12px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                color: white;
            `;
            
            const addedCount = changes.filter(c => c.type === 'add').length;
            const removedCount = changes.filter(c => c.type === 'remove').length;
            
            statsDiv.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 16px; font-weight: bold; margin-bottom: 10px; opacity: 0.9;">üìä ÂØπÊØîÁªüËÆ°</div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                    <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px);">
                        <div style="font-size: 12px; opacity: 0.8; margin-bottom: 5px;">üìÑ Âü∫Á°ÄÁâàÊú¨</div>
                        <div style="font-size: 11px; line-height: 1.6;">
                            ${new Date(v1.timestamp).toLocaleString('zh-CN', {month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'})}<br>
                            ${v1.comment ? v1.comment : 'Êó†Â§áÊ≥®'}
                        </div>
                    </div>
                    <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px);">
                        <div style="font-size: 12px; opacity: 0.8; margin-bottom: 5px;">üìÑ ÂØπÊØîÁâàÊú¨</div>
                        <div style="font-size: 11px; line-height: 1.6;">
                            ${new Date(v2.timestamp).toLocaleString('zh-CN', {month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'})}<br>
                            ${v2.comment ? v2.comment : 'Êó†Â§áÊ≥®'}
                        </div>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-around; margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2);">
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #4ade80;">+${addedCount}</div>
                        <div style="font-size: 11px; opacity: 0.8;">Êñ∞Â¢ûË°å</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #f87171;">-${removedCount}</div>
                        <div style="font-size: 11px; opacity: 0.8;">Âà†Èô§Ë°å</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #fbbf24;">¬±${Math.min(addedCount, removedCount)}</div>
                        <div style="font-size: 11px; opacity: 0.8;">‰øÆÊîπË°å</div>
                    </div>
                </div>
            `;
            
            console.log('ÁªüËÆ°‰ø°ÊÅØÂ∑≤Ê∑ªÂä†');

            // ÁæéÂåñÁöÑÂ∑ÆÂºÇÊ∏≤Êüì
            const diffDiv = this.diffContainer.createEl('div');
            diffDiv.style.cssText = `
                margin-top: 20px;
                padding: 0;
                background: #1e1e1e;
                border-radius: 12px;
                overflow: hidden;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            `;
            
            // Ê∑ªÂä†Ê†áÈ¢òÊ†è
            const titleBar = diffDiv.createEl('div');
            titleBar.style.cssText = `
                padding: 12px 15px;
                background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
                color: white;
                font-size: 13px;
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 8px;
            `;
            titleBar.innerHTML = `
                <span style="font-size: 16px;">üìù</span>
                <span>Â∑ÆÂºÇÂÜÖÂÆπ</span>
                <span style="margin-left: auto; font-size: 11px; opacity: 0.7;">${changes.length > 50 ? 'ÊòæÁ§∫Ââç50Ë°å' : `ÂÖ±${changes.length}Ë°å`}</span>
            `;
            
            const contentDiv = diffDiv.createEl('div');
            contentDiv.style.cssText = `
                max-height: 400px;
                overflow-y: auto;
                font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
                font-size: 13px;
                line-height: 1.6;
            `;
            
            if (changes.length === 0) {
                const emptyDiv = contentDiv.createEl('div');
                emptyDiv.style.cssText = 'padding: 40px 20px; text-align: center; color: #94a3b8;';
                emptyDiv.innerHTML = `
                    <div style="font-size: 48px; margin-bottom: 10px;">‚ú®</div>
                    <div style="font-size: 14px;">‰∏§‰∏™ÁâàÊú¨ÂÜÖÂÆπÂÆåÂÖ®Áõ∏Âêå</div>
                `;
            } else {
                // Âè™ÊòæÁ§∫Ââç50Ë°åÂèòÊõ¥
                const displayChanges = changes.slice(0, 50);
                
                displayChanges.forEach((change, idx) => {
                    const lineDiv = contentDiv.createEl('div');
                    lineDiv.style.cssText = `
                        padding: 8px 15px;
                        margin: 0;
                        border-left: 3px solid transparent;
                        transition: background-color 0.15s ease;
                    `;
                    
                    let prefix = '  ';
                    let bgColor = 'transparent';
                    let textColor = '#e2e8f0';
                    let borderColor = 'transparent';
                    
                    if (change.type === 'add') {
                        prefix = '+ ';
                        bgColor = 'rgba(34, 197, 94, 0.15)';
                        textColor = '#86efac';
                        borderColor = '#22c55e';
                        lineDiv.style.cssText += `
                            background: ${bgColor};
                            color: ${textColor};
                            border-left-color: ${borderColor};
                        `;
                    } else if (change.type === 'remove') {
                        prefix = '- ';
                        bgColor = 'rgba(239, 68, 68, 0.15)';
                        textColor = '#fca5a5';
                        borderColor = '#ef4444';
                        lineDiv.style.cssText += `
                            background: ${bgColor};
                            color: ${textColor};
                            border-left-color: ${borderColor};
                        `;
                    } else {
                        lineDiv.style.cssText += `
                            color: ${textColor};
                        `;
                    }
                    
                    const content = this.escapeHtml(change.content);
                    const displayContent = content || '<span style="opacity: 0.5;">(Á©∫Ë°å)</span>';
                    
                    lineDiv.innerHTML = `
                        <span style="opacity: 0.5; margin-right: 10px; user-select: none;">${String(idx + 1).padStart(3, ' ')}</span>
                        <span style="opacity: 0.7; margin-right: 8px;">${prefix}</span>
                        <span>${displayContent}</span>
                    `;
                });
                
                if (changes.length > 50) {
                    const moreDiv = contentDiv.createEl('div');
                    moreDiv.style.cssText = `
                        padding: 15px;
                        text-align: center;
                        background: linear-gradient(to bottom, transparent, rgba(100,116,139,0.1));
                        color: #94a3b8;
                        font-size: 12px;
                        border-top: 1px solid rgba(148,163,184,0.1);
                    `;
                    moreDiv.innerHTML = `
                        <span style="opacity: 0.7;">‚¨áÔ∏è ËøòÊúâ ${changes.length - 50} Ë°åÂèòÊõ¥Êú™ÊòæÁ§∫</span><br>
                        <span style="font-size: 11px; opacity: 0.5;">ÂèØ‰ΩøÁî®"ÂØºÂá∫Êä•Âëä"ÂäüËÉΩÊü•ÁúãÂÆåÊï¥ÂÜÖÂÆπ</span>
                    `;
                }
            }
            
            console.log('Â∑ÆÂºÇÂÜÖÂÆπÂ∑≤Ê∏≤Êüì');
            console.log('ÂØπÊØîÂÆåÊàê');
            new Notice('‚úÖ ÂØπÊØîÂÆåÊàê');
            
        } catch (error) {
            console.error('ÂØπÊØîÂ§±Ë¥•:', error);
            console.error('ÈîôËØØÂ†ÜÊ†à:', error.stack);
            new Notice('ÂØπÊØîÂ§±Ë¥•: ' + error.message);
            
            // ÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ
            this.diffContainer.empty();
            const errorDiv = this.diffContainer.createEl('div');
            errorDiv.style.cssText = `
                padding: 25px;
                background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
                color: white;
                border-radius: 12px;
                margin: 15px 0;
                box-shadow: 0 4px 15px rgba(239,68,68,0.3);
            `;
            errorDiv.innerHTML = `
                <div style="font-size: 16px; font-weight: bold; margin-bottom: 10px;">‚ùå ÂØπÊØîÂá∫Èîô</div>
                <div style="font-size: 13px; opacity: 0.9;">${error.message}</div>
            `;
        }
    }

    filterChanges(changes) {
        const filtered = [];
        const contextLines = this.contextLines;
        
        for (let i = 0; i < changes.length; i++) {
            if (changes[i].type !== 'context') {
                // Ê∑ªÂä†ÂèòÊõ¥Ë°å
                filtered.push(changes[i]);
                
                // Ê∑ªÂä†‰∏ä‰∏ãÊñá
                for (let j = Math.max(0, i - contextLines); j < i; j++) {
                    if (changes[j].type === 'context' && !filtered.includes(changes[j])) {
                        filtered.push({ ...changes[j], isContext: true });
                    }
                }
                for (let j = i + 1; j <= Math.min(changes.length - 1, i + contextLines); j++) {
                    if (changes[j].type === 'context') {
                        filtered.push({ ...changes[j], isContext: true });
                    } else {
                        break;
                    }
                }
            }
        }
        
        return filtered;
    }

    async copyDiffToClipboard() {
        const { v1, v2 } = this.currentDiff;
        let text = `ÁâàÊú¨ÂØπÊØî\n`;
        text += `Âü∫Á°ÄÁâàÊú¨: ${new Date(v1.timestamp).toLocaleString('zh-CN')}\n`;
        text += `ÂØπÊØîÁâàÊú¨: ${new Date(v2.timestamp).toLocaleString('zh-CN')}\n\n`;
        
        const diff = new DiffEngine(v1.content, v2.content, this.ignoreWhitespace);
        const changes = diff.compute();
        
        changes.forEach(change => {
            if (change.type === 'add') {
                text += `+ ${change.content}\n`;
            } else if (change.type === 'remove') {
                text += `- ${change.content}\n`;
            } else if (!this.showOnlyChanges) {
                text += `  ${change.content}\n`;
            }
        });
        
        await navigator.clipboard.writeText(text);
        new Notice('Â∑ÆÂºÇÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø');
    }

    async exportDiffReport(v1, v2) {
        const diff = new DiffEngine(v1.content, v2.content, this.ignoreWhitespace);
        const changes = diff.compute();
        const stats = this.plugin.analyzeDiffStats(changes);
        
        let report = `# ÁâàÊú¨Â∑ÆÂºÇÊä•Âëä\n\n`;
        report += `## Âü∫Êú¨‰ø°ÊÅØ\n\n`;
        report += `- Êñá‰ª∂: ${this.file.path}\n`;
        report += `- ÁîüÊàêÊó∂Èó¥: ${new Date().toLocaleString('zh-CN')}\n\n`;
        
        report += `## ÁâàÊú¨ÂØπÊØî\n\n`;
        report += `### Âü∫Á°ÄÁâàÊú¨ (v${this.plugin.getVersions(this.file).indexOf(v1) + 1})\n`;
        report += `- Êó∂Èó¥: ${new Date(v1.timestamp).toLocaleString('zh-CN')}\n`;
        report += `- Â§áÊ≥®: ${v1.comment || 'Êó†'}\n`;
        report += `- Â§ßÂ∞è: ${this.plugin.formatSize(v1.size)}\n`;
        report += `- Ë°åÊï∞: ${v1.metadata?.lineCount || v1.content.split('\n').length}\n\n`;
        
        report += `### ÂØπÊØîÁâàÊú¨ (v${this.plugin.getVersions(this.file).indexOf(v2) + 1})\n`;
        report += `- Êó∂Èó¥: ${new Date(v2.timestamp).toLocaleString('zh-CN')}\n`;
        report += `- Â§áÊ≥®: ${v2.comment || 'Êó†'}\n`;
        report += `- Â§ßÂ∞è: ${this.plugin.formatSize(v2.size)}\n`;
        report += `- Ë°åÊï∞: ${v2.metadata?.lineCount || v2.content.split('\n').length}\n\n`;
        
        report += `## ÂèòÊõ¥ÁªüËÆ°\n\n`;
        report += `- ‚ûï Êñ∞Â¢û: ${stats.added} Ë°å\n`;
        report += `- ‚ûñ Âà†Èô§: ${stats.removed} Ë°å\n`;
        report += `- ‚úèÔ∏è ‰øÆÊîπ: ${stats.modified} Ë°å\n`;
        report += `- üìä ÊÄªÂèòÊõ¥: ${stats.added + stats.removed} Ë°å\n\n`;
        
        report += `## ËØ¶ÁªÜÂ∑ÆÂºÇ\n\n`;
        report += '```diff\n';
        changes.forEach(change => {
            if (change.type === 'add') {
                report += `+ ${change.content}\n`;
            } else if (change.type === 'remove') {
                report += `- ${change.content}\n`;
            } else {
                report += `  ${change.content}\n`;
            }
        });
        report += '```\n';
        
        const fileName = `${this.file.basename}_Â∑ÆÂºÇÊä•Âëä_${new Date().toISOString().split('T')[0]}.md`;
        await this.plugin.app.vault.create(fileName, report);
        new Notice(`Â∑ÆÂºÇÊä•ÂëäÂ∑≤ÂØºÂá∫: ${fileName}`);
    }

    renderUnifiedDiff(changes) {
        const viewEl = this.diffContainer.createEl('div', { cls: 'diff-view unified' });
        
        // Á°Æ‰øùÂÆπÂô®ÂèØËßÅ
        viewEl.style.minHeight = '200px';
        viewEl.style.border = '1px solid var(--background-modifier-border)';
        viewEl.style.padding = '10px';
        viewEl.style.marginTop = '10px';
        
        if (changes.length === 0) {
            viewEl.createEl('div', { text: '‰∏§‰∏™ÁâàÊú¨ÂÜÖÂÆπÁõ∏ÂêåÔºåÊ≤°ÊúâÂ∑ÆÂºÇ', cls: 'no-changes' });
            return;
        }
        
        let lineNum1 = 1, lineNum2 = 1;
        
        changes.forEach(change => {
            const lineEl = viewEl.createEl('div', { cls: 'diff-line' });
            lineEl.style.minHeight = '20px';
            lineEl.style.padding = '2px 0';
            
            const lineNumbers = lineEl.createEl('span', { cls: 'line-numbers' });
            lineNumbers.style.display = 'inline-block';
            lineNumbers.style.marginRight = '10px';
            lineNumbers.style.minWidth = '80px';
            
            if (change.type === 'context') {
                lineNumbers.createEl('span', { 
                    cls: 'line-num old', 
                    text: lineNum1.toString() 
                });
                lineNumbers.createEl('span', { 
                    cls: 'line-num new', 
                    text: ' | ' + lineNum2.toString() 
                });
                lineEl.addClass('diff-context');
                lineEl.style.backgroundColor = 'transparent';
                lineEl.createEl('span', { cls: 'line-content', text: '  ' + change.content });
                lineNum1++;
                lineNum2++;
            } else if (change.type === 'remove') {
                lineNumbers.createEl('span', { 
                    cls: 'line-num old', 
                    text: lineNum1.toString() 
                });
                lineNumbers.createEl('span', { 
                    cls: 'line-num new empty', 
                    text: ' |  ' 
                });
                lineEl.addClass('diff-removed');
                lineEl.style.backgroundColor = 'rgba(220, 53, 69, 0.15)';
                lineEl.createEl('span', { 
                    cls: 'line-content', 
                    text: '- ' + change.content 
                }).style.color = '#dc3545';
                lineNum1++;
            } else if (change.type === 'add') {
                lineNumbers.createEl('span', { 
                    cls: 'line-num old empty', 
                    text: '   ' 
                });
                lineNumbers.createEl('span', { 
                    cls: 'line-num new', 
                    text: '| ' + lineNum2.toString() 
                });
                lineEl.addClass('diff-added');
                lineEl.style.backgroundColor = 'rgba(40, 167, 69, 0.15)';
                lineEl.createEl('span', { 
                    cls: 'line-content', 
                    text: '+ ' + change.content 
                }).style.color = '#28a745';
                lineNum2++;
            }
        });
        
        console.log('Ê∏≤Êüì‰∫Ü', changes.length, 'Ë°åÂ∑ÆÂºÇ');
    }

    renderSplitDiff(content1, content2, changes) {
        const viewEl = this.diffContainer.createEl('div', { cls: 'diff-view split' });
        
        // ÂÜÖËÅîÊ†∑ÂºèÁ°Æ‰øùÊòæÁ§∫
        viewEl.style.display = 'grid';
        viewEl.style.gridTemplateColumns = '1fr 1fr';
        viewEl.style.border = '1px solid var(--background-modifier-border)';
        viewEl.style.marginTop = '10px';
        viewEl.style.minHeight = '200px';
        
        const leftEl = viewEl.createEl('div', { cls: 'diff-side left' });
        leftEl.style.borderRight = '2px solid var(--background-modifier-border)';
        leftEl.style.padding = '10px';
        leftEl.style.overflowX = 'auto';
        
        const rightEl = viewEl.createEl('div', { cls: 'diff-side right' });
        rightEl.style.padding = '10px';
        rightEl.style.overflowX = 'auto';
        
        const lines1 = content1.split('\n');
        const lines2 = content2.split('\n');
        
        let idx1 = 0, idx2 = 0;
        
        changes.forEach(change => {
            if (change.type === 'context') {
                const line = leftEl.createEl('div', { cls: 'diff-line context' });
                line.textContent = change.content;
                line.style.padding = '2px 5px';
                
                const line2 = rightEl.createEl('div', { cls: 'diff-line context' });
                line2.textContent = change.content;
                line2.style.padding = '2px 5px';
                
                idx1++;
                idx2++;
            } else if (change.type === 'remove') {
                const line = leftEl.createEl('div', { cls: 'diff-line removed' });
                line.textContent = change.content;
                line.style.backgroundColor = 'rgba(220, 53, 69, 0.15)';
                line.style.color = '#dc3545';
                line.style.padding = '2px 5px';
                
                const spacer = rightEl.createEl('div', { cls: 'diff-line spacer' });
                spacer.style.backgroundColor = 'var(--background-primary-alt)';
                spacer.style.minHeight = '20px';
                idx1++;
            } else if (change.type === 'add') {
                const spacer = leftEl.createEl('div', { cls: 'diff-line spacer' });
                spacer.style.backgroundColor = 'var(--background-primary-alt)';
                spacer.style.minHeight = '20px';
                
                const line2 = rightEl.createEl('div', { cls: 'diff-line added' });
                line2.textContent = change.content;
                line2.style.backgroundColor = 'rgba(40, 167, 69, 0.15)';
                line2.style.color = '#28a745';
                line2.style.padding = '2px 5px';
                
                idx2++;
            }
        });
        
        console.log('ÂàÜÂ±èÊ∏≤ÊüìÂÆåÊàê');
    }

    renderInlineDiff(content1, content2) {
        const viewEl = this.diffContainer.createEl('div', { cls: 'diff-view inline' });
        
        // ÂÜÖËÅîÊ†∑ÂºèÁ°Æ‰øùÊòæÁ§∫
        viewEl.style.border = '1px solid var(--background-modifier-border)';
        viewEl.style.marginTop = '10px';
        viewEl.style.minHeight = '200px';
        
        const lines1 = content1.split('\n');
        const lines2 = content2.split('\n');
        
        const maxLine = Math.max(lines1.length, lines2.length);
        
        for (let i = 0; i < maxLine; i++) {
            const line1 = lines1[i] || '';
            const line2 = lines2[i] || '';
            
            const lineEl = viewEl.createEl('div', { cls: 'diff-line-pair' });
            lineEl.style.display = 'grid';
            lineEl.style.gridTemplateColumns = '1fr 1fr';
            lineEl.style.borderBottom = '1px solid var(--background-modifier-border)';
            
            const leftPart = lineEl.createEl('div', { cls: 'diff-line-part left' });
            leftPart.style.padding = '5px 10px';
            leftPart.style.borderRight = '1px solid var(--background-modifier-border)';
            leftPart.style.wordBreak = 'break-all';
            
            const rightPart = lineEl.createEl('div', { cls: 'diff-line-part right' });
            rightPart.style.padding = '5px 10px';
            rightPart.style.wordBreak = 'break-all';
            
            if (line1 === line2) {
                leftPart.addClass('context');
                rightPart.addClass('context');
                leftPart.textContent = line1;
                rightPart.textContent = line2;
            } else {
                if (line1) {
                    leftPart.addClass('removed');
                    leftPart.style.backgroundColor = 'rgba(220, 53, 69, 0.15)';
                    leftPart.innerHTML = this.highlightChanges(line1, line2);
                }
                if (line2) {
                    rightPart.addClass('added');
                    rightPart.style.backgroundColor = 'rgba(40, 167, 69, 0.15)';
                    rightPart.innerHTML = this.highlightChanges(line2, line1);
                }
            }
        }
        
        console.log('Ë°åÂÜÖÊ∏≤ÊüìÂÆåÊàê');
    }

    highlightChanges(current, other) {
        const chars1 = current.split('');
        const chars2 = other.split('');
        
        let result = '';
        let i = 0;
        
        while (i < chars1.length) {
            if (i < chars2.length && chars1[i] === chars2[i]) {
                result += this.escapeHtml(chars1[i]);
                i++;
            } else {
                let j = i;
                let changed = '';
                while (j < chars1.length && (j >= chars2.length || chars1[j] !== chars2[j])) {
                    changed += chars1[j];
                    j++;
                }
                result += `<mark>${this.escapeHtml(changed)}</mark>`;
                i = j;
            }
        }
        
        return result;
    }

    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    onClose() {
        const { contentEl } = this;
        contentEl.empty();
    }
}

// Êñ∞Â¢û: ÂèòÊõ¥È¢ÑËßàModal
class ChangePreviewModal extends Modal {
    constructor(app, changes) {
        super(app);
        this.changes = changes;
    }

    onOpen() {
        const { contentEl } = this;
        contentEl.empty();

        contentEl.createEl('h2', { text: 'üìä ÂèòÊõ¥È¢ÑËßà' });

        const addedCount = this.changes.filter(c => c.type === 'add').length;
        const removedCount = this.changes.filter(c => c.type === 'remove').length;

        const stats = contentEl.createEl('div', { cls: 'change-stats' });
        stats.createEl('span', { text: `‚ûï Êñ∞Â¢û ${addedCount} Ë°å` });
        stats.createEl('span', { text: ` | ` });
        stats.createEl('span', { text: `‚ûñ Âà†Èô§ ${removedCount} Ë°å` });

        const previewEl = contentEl.createEl('div', { cls: 'change-preview' });
        
        this.changes.forEach(change => {
            const lineEl = previewEl.createEl('div', { cls: 'preview-line' });
            
            if (change.type === 'add') {
                lineEl.addClass('added');
                lineEl.textContent = '+ ' + change.content;
            } else if (change.type === 'remove') {
                lineEl.addClass('removed');
                lineEl.textContent = '- ' + change.content;
            } else {
                lineEl.addClass('context');
                lineEl.textContent = '  ' + change.content;
            }
        });
    }

    onClose() {
        const { contentEl } = this;
        contentEl.empty();
    }
}

// Êñ∞Â¢û: ÂêàÂπ∂ÁâàÊú¨Modal
class MergeVersionModal extends Modal {
    constructor(app, plugin, file) {
        super(app);
        this.plugin = plugin;
        this.file = file;
    }

    onOpen() {
        const { contentEl } = this;
        contentEl.empty();

        contentEl.createEl('h2', { text: 'üîÄ ÂêàÂπ∂ÁâàÊú¨' });
        contentEl.createEl('p', { text: 'ÈÄâÊã©Ë¶ÅÂêàÂπ∂ÁöÑÁâàÊú¨' });

        const versions = this.plugin.getVersions(this.file);
        
        if (versions.length < 2) {
            contentEl.createEl('p', { text: 'Ëá≥Â∞ëÈúÄË¶Å‰∏§‰∏™ÁâàÊú¨ÊâçËÉΩÂêàÂπ∂' });
            return;
        }

        let baseVersionIndex = 0;
        let mergeVersionIndex = versions.length - 1;

        new Setting(contentEl)
            .setName('Âü∫Á°ÄÁâàÊú¨')
            .addDropdown(dropdown => {
                versions.forEach((v, i) => {
                    const date = new Date(v.timestamp).toLocaleString('zh-CN');
                    dropdown.addOption(i.toString(), `ÁâàÊú¨ ${i + 1} - ${date}`);
                });
                dropdown.onChange(value => { baseVersionIndex = parseInt(value); });
            });

        new Setting(contentEl)
            .setName('ÂêàÂπ∂ÁâàÊú¨')
            .addDropdown(dropdown => {
                versions.forEach((v, i) => {
                    const date = new Date(v.timestamp).toLocaleString('zh-CN');
                    dropdown.addOption(i.toString(), `ÁâàÊú¨ ${i + 1} - ${date}`);
                });
                dropdown.setValue(mergeVersionIndex.toString());
                dropdown.onChange(value => { mergeVersionIndex = parseInt(value); });
            });

        new Setting(contentEl)
            .addButton(btn => btn.setButtonText('ÂêàÂπ∂').setCta().onClick(async () => {
                if (baseVersionIndex === mergeVersionIndex) {
                    new Notice('ËØ∑ÈÄâÊã©‰∏çÂêåÁöÑÁâàÊú¨');
                    return;
                }
                
                const baseVersion = versions[baseVersionIndex];
                const mergeVersion = versions[mergeVersionIndex];
                
                // ÁÆÄÂçïÂêàÂπ∂Á≠ñÁï•: ‰ΩøÁî®ËæÉÊñ∞ÁâàÊú¨ÁöÑÂÜÖÂÆπ
                const mergedContent = mergeVersion.content;
                
                await this.plugin.app.vault.modify(this.file, mergedContent);
                await this.plugin.saveVersion(this.file, `ÂêàÂπ∂ÁâàÊú¨ ${baseVersionIndex + 1} Âíå ${mergeVersionIndex + 1}`);
                
                new Notice('ÁâàÊú¨Â∑≤ÂêàÂπ∂');
                this.close();
            }))
            .addButton(btn => btn.setButtonText('ÂèñÊ∂à').onClick(() => this.close()));
    }

    onClose() {
        const { contentEl } = this;
        contentEl.empty();
    }
}

// Êñ∞Â¢û: Ê†áÁ≠æÁâàÊú¨Modal
class TagVersionModal extends Modal {
    constructor(app, plugin, file) {
        super(app);
        this.plugin = plugin;
        this.file = file;
        this.selectedVersion = -1;
        this.newTag = '';
    }

    onOpen() {
        const { contentEl } = this;
        contentEl.empty();

        contentEl.createEl('h2', { text: 'üè∑Ô∏è ÁÆ°ÁêÜÁâàÊú¨Ê†áÁ≠æ' });

        const versions = this.plugin.getVersions(this.file);
        
        if (versions.length === 0) {
            contentEl.createEl('p', { text: 'ÊöÇÊó†ÁâàÊú¨' });
            return;
        }

        new Setting(contentEl)
            .setName('ÈÄâÊã©ÁâàÊú¨')
            .addDropdown(dropdown => {
                versions.forEach((v, i) => {
                    const date = new Date(v.timestamp).toLocaleString('zh-CN');
                    dropdown.addOption(i.toString(), `ÁâàÊú¨ ${i + 1} - ${date}`);
                });
                dropdown.setValue((versions.length - 1).toString());
                dropdown.onChange(value => { 
                    this.selectedVersion = parseInt(value);
                    this.displayCurrentTags();
                });
                this.selectedVersion = versions.length - 1;
            });

        this.tagsContainer = contentEl.createEl('div', { cls: 'tags-container' });
        this.displayCurrentTags();

        new Setting(contentEl)
            .setName('Êñ∞Ê†áÁ≠æ')
            .addText(text => text
                .setPlaceholder('ËæìÂÖ•Ê†áÁ≠æÂêçÁß∞')
                .onChange(value => { this.newTag = value; }));

        new Setting(contentEl)
            .addButton(btn => btn.setButtonText('Ê∑ªÂä†Ê†áÁ≠æ').setCta().onClick(() => {
                if (this.newTag && this.selectedVersion >= 0) {
                    this.plugin.addVersionTag(this.file.path, this.selectedVersion, this.newTag);
                    this.newTag = '';
                    this.displayCurrentTags();
                    new Notice('Ê†áÁ≠æÂ∑≤Ê∑ªÂä†');
                }
            }))
            .addButton(btn => btn.setButtonText('ÂÖ≥Èó≠').onClick(() => this.close()));
    }

    displayCurrentTags() {
        this.tagsContainer.empty();
        
        if (this.selectedVersion < 0) return;

        const tags = this.plugin.getVersionTags(this.file.path, this.selectedVersion);
        
        if (tags.length === 0) {
            this.tagsContainer.createEl('p', { text: 'ÊöÇÊó†Ê†áÁ≠æ' });
            return;
        }

        this.tagsContainer.createEl('h4', { text: 'ÂΩìÂâçÊ†áÁ≠æ:' });
        const tagList = this.tagsContainer.createEl('div', { cls: 'tag-list' });
        
        tags.forEach(tag => {
            const tagEl = tagList.createEl('span', { cls: 'tag-item', text: tag });
            const removeBtn = tagEl.createEl('span', { cls: 'tag-remove', text: ' √ó' });
            removeBtn.addEventListener('click', () => {
                // ÁßªÈô§Ê†áÁ≠æÈÄªËæë
                const currentTags = this.plugin.getVersionTags(this.file.path, this.selectedVersion);
                const index = currentTags.indexOf(tag);
                if (index > -1) {
                    currentTags.splice(index, 1);
                    this.plugin.saveVersionData();
                    this.displayCurrentTags();
                }
            });
        });
    }

    onClose() {
        const { contentEl } = this;
        contentEl.empty();
    }
}

// Êñ∞Â¢û: Êó∂Èó¥Á∫øModal
class TimelineModal extends Modal {
    constructor(app, plugin) {
        super(app);
        this.plugin = plugin;
    }

    onOpen() {
        const { contentEl } = this;
        contentEl.empty();

        contentEl.createEl('h2', { text: 'üìÖ ÁâàÊú¨Êó∂Èó¥Á∫ø' });

        const allVersions = [];
        const versionData = this.plugin.getAllVersions();

        for (const filePath in versionData) {
            versionData[filePath].forEach((version, index) => {
                allVersions.push({
                    filePath,
                    version,
                    index
                });
            });
        }

        allVersions.sort((a, b) => b.version.timestamp - a.version.timestamp);

        if (allVersions.length === 0) {
            contentEl.createEl('p', { text: 'ÊöÇÊó†ÁâàÊú¨ÂéÜÂè≤' });
            return;
        }

        const timeline = contentEl.createEl('div', { cls: 'timeline' });

        allVersions.slice(0, 50).forEach(item => {
            const timelineItem = timeline.createEl('div', { cls: 'timeline-item' });
            
            const date = new Date(item.version.timestamp);
            const dateStr = date.toLocaleString('zh-CN');
            
            timelineItem.createEl('div', { 
                text: dateStr,
                cls: 'timeline-date'
            });
            
            timelineItem.createEl('div', { 
                text: item.filePath,
                cls: 'timeline-file'
            });
            
            if (item.version.comment) {
                timelineItem.createEl('div', { 
                    text: item.version.comment,
                    cls: 'timeline-comment'
                });
            }
            
            if (item.version.isSnapshot) {
                timelineItem.createEl('span', { 
                    text: 'üìå Âø´ÁÖß',
                    cls: 'timeline-badge'
                });
            }
        });
    }

    onClose() {
        const { contentEl } = this;
        contentEl.empty();
    }
}

class SnapshotModal extends Modal {
    constructor(app, plugin, file) {
        super(app);
        this.plugin = plugin;
        this.file = file;
        this.comment = '';
    }

    onOpen() {
        const { contentEl } = this;
        contentEl.empty();

        contentEl.createEl('h2', { text: 'üìå ÂàõÂª∫Âø´ÁÖß' });
        contentEl.createEl('p', { text: 'Âø´ÁÖßÊòØÂèó‰øùÊä§ÁöÑÁâàÊú¨,‰∏ç‰ºöË¢´Ëá™Âä®Ê∏ÖÁêÜ' });
        contentEl.createEl('p', { text: `Êñá‰ª∂: ${this.file.name}` });

        new Setting(contentEl)
            .setName('Âø´ÁÖßËØ¥Êòé')
            .setDesc('ÊèèËø∞Ëøô‰∏™Âø´ÁÖßÁöÑÈáçË¶ÅÊÄß')
            .addTextArea(text => text
                .setPlaceholder('‰æãÂ¶Ç:ÈáçÂ§ßÂäüËÉΩÂÆåÊàêÂâçÁöÑÁ®≥ÂÆöÁâàÊú¨')
                .onChange(value => { this.comment = value; }));

        new Setting(contentEl)
            .addButton(btn => btn.setButtonText('ÂàõÂª∫Âø´ÁÖß').setCta().onClick(() => {
                this.plugin.saveVersion(this.file, this.comment || 'Âø´ÁÖß', true);
                this.close();
            }))
            .addButton(btn => btn.setButtonText('ÂèñÊ∂à').onClick(() => this.close()));
    }

    onClose() {
        const { contentEl } = this;
        contentEl.empty();
    }
}

class CleanupModal extends Modal {
    constructor(app, plugin) {
        super(app);
        this.plugin = plugin;
        this.daysOld = 30;
    }

    onOpen() {
        const { contentEl } = this;
        contentEl.empty();

        contentEl.createEl('h2', { text: 'üóëÔ∏è Ê∏ÖÁêÜÊóßÁâàÊú¨' });
        
        const stats = this.getStats();
        contentEl.createEl('p', { text: `ÂΩìÂâçÊúâ ${stats.totalVersions} ‰∏™ÁâàÊú¨,Âç†Áî® ${this.plugin.formatSize(stats.totalSize)}` });

        new Setting(contentEl)
            .setName('Ê∏ÖÁêÜÊó∂Èó¥')
            .setDesc('Âà†Èô§Â§öÂ∞ëÂ§©ÂâçÁöÑÁâàÊú¨(Âø´ÁÖßÈô§Â§ñ)')
            .addSlider(slider => slider
                .setLimits(7, 365, 1)
                .setValue(this.daysOld)
                .setDynamicTooltip()
                .onChange(value => {
                    this.daysOld = value;
                    this.updatePreview();
                }));

        this.previewEl = contentEl.createEl('div', { cls: 'cleanup-preview' });
        this.updatePreview();

        new Setting(contentEl)
            .addButton(btn => btn.setButtonText('ÊâßË°åÊ∏ÖÁêÜ').setWarning().onClick(async () => {
                const removed = await this.plugin.cleanupOldVersions(this.daysOld);
                new Notice(`Â∑≤Ê∏ÖÁêÜ ${removed} ‰∏™ÁâàÊú¨`);
                this.close();
            }))
            .addButton(btn => btn.setButtonText('ÂèñÊ∂à').onClick(() => this.close()));
    }

    getStats() {
        const versionData = this.plugin.getAllVersions();
        let totalVersions = 0;
        let totalSize = 0;
        
        for (const filePath in versionData) {
            totalVersions += versionData[filePath].length;
            versionData[filePath].forEach(v => {
                totalSize += v.size || 0;
            });
        }
        
        return { totalVersions, totalSize };
    }

    updatePreview() {
        const cutoffTime = Date.now() - (this.daysOld * 24 * 60 * 60 * 1000);
        let toRemove = 0;
        
        const versionData = this.plugin.getAllVersions();
        for (const filePath in versionData) {
            versionData[filePath].forEach(v => {
                if (!v.isSnapshot && v.timestamp < cutoffTime) {
                    toRemove++;
                }
            });
        }
        
        this.previewEl.setText(`Â∞ÜÂà†Èô§ ${toRemove} ‰∏™ÁâàÊú¨`);
    }

    onClose() {
        const { contentEl } = this;
        contentEl.empty();
    }
}

class StatsModal extends Modal {
    constructor(app, plugin) {
        super(app);
        this.plugin = plugin;
    }

    onOpen() {
        const { contentEl } = this;
        contentEl.empty();

        contentEl.createEl('h2', { text: 'üìä ÁâàÊú¨ÁªüËÆ°' });

        const versionData = this.plugin.getAllVersions();
        const stats = this.calculateStats(versionData);

        const statsContainer = contentEl.createEl('div', { cls: 'stats-container' });

        this.addStatItem(statsContainer, 'ÊÄªÁâàÊú¨Êï∞', stats.totalVersions);
        this.addStatItem(statsContainer, 'ÊÄªÂç†Áî®Á©∫Èó¥', this.plugin.formatSize(stats.totalSize));
        this.addStatItem(statsContainer, 'Êñá‰ª∂Êï∞', stats.fileCount);
        this.addStatItem(statsContainer, 'Âø´ÁÖßÊï∞', stats.snapshotCount);
        this.addStatItem(statsContainer, 'Âπ≥ÂùáÁâàÊú¨/Êñá‰ª∂', stats.avgVersions.toFixed(1));
        this.addStatItem(statsContainer, 'ÊúÄÂ§ßÁâàÊú¨Êï∞', stats.maxVersionsPerFile);

        contentEl.createEl('h3', { text: 'Êñá‰ª∂ÁâàÊú¨ËØ¶ÊÉÖ' });
        const fileList = contentEl.createEl('div', { cls: 'file-list' });

        stats.fileDetails.forEach(detail => {
            const fileItem = fileList.createEl('div', { cls: 'file-item' });
            fileItem.createEl('div', { text: detail.path, cls: 'file-path' });
            fileItem.createEl('div', { 
                text: `${detail.versions} ‰∏™ÁâàÊú¨ | ${this.plugin.formatSize(detail.size)}`,
                cls: 'file-info'
            });
        });
    }

    calculateStats(versionData) {
        let totalVersions = 0;
        let totalSize = 0;
        let snapshotCount = 0;
        let maxVersionsPerFile = 0;
        const fileDetails = [];

        for (const filePath in versionData) {
            const versions = versionData[filePath];
            totalVersions += versions.length;
            maxVersionsPerFile = Math.max(maxVersionsPerFile, versions.length);
            
            let fileSize = 0;
            versions.forEach(v => {
                totalSize += v.size || 0;
                fileSize += v.size || 0;
                if (v.isSnapshot) snapshotCount++;
            });

            fileDetails.push({
                path: filePath,
                versions: versions.length,
                size: fileSize
            });
        }

        fileDetails.sort((a, b) => b.versions - a.versions);

        return {
            totalVersions,
            totalSize,
            fileCount: Object.keys(versionData).length,
            snapshotCount,
            maxVersionsPerFile,
            avgVersions: totalVersions / Math.max(1, Object.keys(versionData).length),
            fileDetails: fileDetails.slice(0, 10)
        };
    }

    addStatItem(container, label, value) {
        const item = container.createEl('div', { cls: 'stat-item' });
        item.createEl('div', { text: label, cls: 'stat-label' });
        item.createEl('div', { text: value.toString(), cls: 'stat-value' });
    }

    onClose() {
        const { contentEl } = this;
        contentEl.empty();
    }
}

class SearchVersionModal extends Modal {
    constructor(app, plugin) {
        super(app);
        this.plugin = plugin;
        this.query = '';
        this.results = [];
    }

    onOpen() {
        const { contentEl } = this;
        contentEl.empty();

        contentEl.createEl('h2', { text: 'üîç ÊêúÁ¥¢ÁâàÊú¨' });

        new Setting(contentEl)
            .setName('ÊêúÁ¥¢ÂÜÖÂÆπ')
            .setDesc('Âú®ÊâÄÊúâÁâàÊú¨‰∏≠ÊêúÁ¥¢ÊñáÊú¨')
            .addText(text => text
                .setPlaceholder('ËæìÂÖ•ÊêúÁ¥¢ÂÖ≥ÈîÆÂ≠ó...')
                .onChange(value => { this.query = value; }));

        new Setting(contentEl)
            .addButton(btn => btn.setButtonText('ÊêúÁ¥¢').setCta().onClick(() => {
                this.performSearch();
            }))
            .addButton(btn => btn.setButtonText('Ê∏ÖÁ©∫').onClick(() => {
                this.resultsContainer.empty();
                this.results = [];
            }));

        this.resultsContainer = contentEl.createEl('div', { cls: 'search-results' });
    }

    performSearch() {
        if (!this.query) {
            new Notice('ËØ∑ËæìÂÖ•ÊêúÁ¥¢ÂÖ≥ÈîÆÂ≠ó');
            return;
        }

        this.results = this.plugin.searchInVersions(this.query);
        this.renderResults();
    }

    renderResults() {
        this.resultsContainer.empty();

        if (this.results.length === 0) {
            this.resultsContainer.createEl('p', { text: 'Êú™ÊâæÂà∞ÂåπÈÖçÁöÑÁâàÊú¨' });
            return;
        }

        const maxResults = this.plugin.settings.maxSearchResults;
        const displayCount = Math.min(this.results.length, maxResults);
        
        this.resultsContainer.createEl('p', { 
            text: `ÊâæÂà∞ ${this.results.length} ‰∏™ÂåπÈÖçÁªìÊûú (ÊòæÁ§∫Ââç ${displayCount} ‰∏™)` 
        });

        const resultList = this.resultsContainer.createEl('div', { cls: 'result-list' });

        this.results.slice(0, maxResults).forEach(result => {
            const resultItem = resultList.createEl('div', { cls: 'result-item' });
            
            resultItem.createEl('div', { 
                text: result.filePath,
                cls: 'result-file'
            });
            
            const date = new Date(result.version.timestamp).toLocaleString('zh-CN');
            resultItem.createEl('div', { 
                text: `ÁâàÊú¨ ${result.versionIndex + 1} - ${date}`,
                cls: 'result-info'
            });
            
            if (result.version.comment) {
                resultItem.createEl('div', { 
                    text: `Â§áÊ≥®: ${result.version.comment}`,
                    cls: 'result-comment'
                });
            }
            
            resultItem.createEl('div', { 
                text: result.excerpt,
                cls: 'result-excerpt'
            });

            resultItem.createEl('button', { text: 'Êü•Áúã' }).addEventListener('click', () => {
                new ViewVersionModal(this.plugin.app, result.version).open();
            });
        });
    }

    onClose() {
        const { contentEl } = this;
        contentEl.empty();
    }
}

class VersionControlSettingTab extends PluginSettingTab {
    constructor(app, plugin) {
        super(app, plugin);
        this.plugin = plugin;
    }

    display() {
        const { containerEl } = this;
        containerEl.empty();

        containerEl.createEl('h2', { text: 'ÁâàÊú¨ÊéßÂà∂ËÆæÁΩÆ' });

        // ÁïåÈù¢ËÆæÁΩÆ
        containerEl.createEl('h3', { text: 'ÁïåÈù¢ËÆæÁΩÆ' });

        new Setting(containerEl)
            .setName('ÊòæÁ§∫Áä∂ÊÄÅÊ†è')
            .setDesc('Âú®Â∫ïÈÉ®Áä∂ÊÄÅÊ†èÊòæÁ§∫ÁâàÊú¨ÁªüËÆ°‰ø°ÊÅØ')
            .addToggle(toggle => toggle
                .setValue(this.plugin.settings.showStatusBar)
                .onChange(async (value) => {
                    this.plugin.settings.showStatusBar = value;
                    await this.plugin.saveSettings();
                    this.plugin.updateStatusBar();
                }));

        new Setting(containerEl)
            .setName('ÊòæÁ§∫ÈÄöÁü•')
            .setDesc('Âú®‰øùÂ≠òÁâàÊú¨Êó∂ÊòæÁ§∫ÈÄöÁü•')
            .addToggle(toggle => toggle
                .setValue(this.plugin.settings.showNotifications)
                .onChange(async (value) => {
                    this.plugin.settings.showNotifications = value;
                    await this.plugin.saveSettings();
                }));

        // Âü∫Á°ÄËÆæÁΩÆ
        containerEl.createEl('h3', { text: 'Âü∫Á°ÄËÆæÁΩÆ' });

        new Setting(containerEl)
            .setName('ÊúÄÂ§ßÁâàÊú¨Êï∞')
            .setDesc('ÊØè‰∏™Êñá‰ª∂‰øùÁïôÁöÑÊúÄÂ§ßÁâàÊú¨Êï∞Èáè(Âø´ÁÖßÈô§Â§ñ)')
            .addSlider(slider => slider
                .setLimits(5, 100, 5)
                .setValue(this.plugin.settings.maxVersions)
                .setDynamicTooltip()
                .onChange(async (value) => {
                    this.plugin.settings.maxVersions = value;
                    await this.plugin.saveSettings();
                }));

        // Ëá™Âä®‰øùÂ≠ò
        containerEl.createEl('h3', { text: 'Ëá™Âä®‰øùÂ≠ò' });

        new Setting(containerEl)
            .setName('ÂêØÁî®Ëá™Âä®‰øùÂ≠ò')
            .setDesc('Âú®Êñá‰ª∂‰øÆÊîπÂêéËá™Âä®‰øùÂ≠òÁâàÊú¨')
            .addToggle(toggle => toggle
                .setValue(this.plugin.settings.enableAutoSave)
                .onChange(async (value) => {
                    this.plugin.settings.enableAutoSave = value;
                    await this.plugin.saveSettings();
                }));

        new Setting(containerEl)
            .setName('Ëá™Âä®‰øùÂ≠òÈó¥Èöî')
            .setDesc('Êñá‰ª∂‰øÆÊîπÂêéÂ§ö‰πÖËá™Âä®‰øùÂ≠ò(ÂàÜÈíü)')
            .addSlider(slider => slider
                .setLimits(1, 60, 1)
                .setValue(this.plugin.settings.autoSaveInterval)
                .setDynamicTooltip()
                .onChange(async (value) => {
                    this.plugin.settings.autoSaveInterval = value;
                    await this.plugin.saveSettings();
                }));

        new Setting(containerEl)
            .setName('Âü∫‰∫éÂèòÊõ¥Ê¨°Êï∞Ëá™Âä®‰øùÂ≠ò')
            .setDesc('ËææÂà∞ÊåáÂÆöÂèòÊõ¥Ê¨°Êï∞Êó∂Ëá™Âä®‰øùÂ≠ò')
            .addToggle(toggle => toggle
                .setValue(this.plugin.settings.autoSaveOnChange)
                .onChange(async (value) => {
                    this.plugin.settings.autoSaveOnChange = value;
                    await this.plugin.saveSettings();
                }));

        new Setting(containerEl)
            .setName('ÊúÄÂ∞èÂèòÊõ¥Ê¨°Êï∞')
            .setDesc('Ëß¶ÂèëËá™Âä®‰øùÂ≠òÊâÄÈúÄÁöÑÊúÄÂ∞èÂèòÊõ¥Ê¨°Êï∞')
            .addSlider(slider => slider
                .setLimits(5, 50, 5)
                .setValue(this.plugin.settings.autoSaveMinChanges)
                .setDynamicTooltip()
                .onChange(async (value) => {
                    this.plugin.settings.autoSaveMinChanges = value;
                    await this.plugin.saveSettings();
                }));

        new Setting(containerEl)
            .setName('ÂêØÁî®Ëá™Âä®Âø´ÁÖß')
            .setDesc('ÂÆöÊó∂Ëá™Âä®ÂàõÂª∫Âø´ÁÖß')
            .addToggle(toggle => toggle
                .setValue(this.plugin.settings.enableAutoSnapshot)
                .onChange(async (value) => {
                    this.plugin.settings.enableAutoSnapshot = value;
                    await this.plugin.saveSettings();
                }));

        new Setting(containerEl)
            .setName('Ëá™Âä®Âø´ÁÖßÈó¥Èöî')
            .setDesc('Ëá™Âä®ÂàõÂª∫Âø´ÁÖßÁöÑÈó¥Èöî(ÂàÜÈíü)')
            .addSlider(slider => slider
                .setLimits(30, 1440, 30)
                .setValue(this.plugin.settings.autoSnapshotInterval)
                .setDynamicTooltip()
                .onChange(async (value) => {
                    this.plugin.settings.autoSnapshotInterval = value;
                    await this.plugin.saveSettings();
                }));

        new Setting(containerEl)
            .setName('ÂêØÁî®Ëá™Âä®Ê∏ÖÁêÜ')
            .setDesc('Ëá™Âä®Âà†Èô§Ë∂ÖËøáÊåáÂÆöÂ§©Êï∞ÁöÑÊóßÁâàÊú¨')
            .addToggle(toggle => toggle
                .setValue(this.plugin.settings.enableAutoCleanup)
                .onChange(async (value) => {
                    this.plugin.settings.enableAutoCleanup = value;
                    await this.plugin.saveSettings();
                }));

        new Setting(containerEl)
            .setName('Ëá™Âä®Ê∏ÖÁêÜÂ§©Êï∞')
            .setDesc('Âà†Èô§Ë∂ÖËøáÂ§öÂ∞ëÂ§©ÁöÑÁâàÊú¨(Âø´ÁÖßÈô§Â§ñ)')
            .addSlider(slider => slider
                .setLimits(7, 365, 7)
                .setValue(this.plugin.settings.autoCleanupDays)
                .setDynamicTooltip()
                .onChange(async (value) => {
                    this.plugin.settings.autoCleanupDays = value;
                    await this.plugin.saveSettings();
                }));

        // ‰æßËæπÊ†èËÆæÁΩÆ
        containerEl.createEl('h3', { text: '‰æßËæπÊ†èËÆæÁΩÆ' });

        new Setting(containerEl)
            .setName('ÊòæÁ§∫ÂÜÖÂÆπÈ¢ÑËßà')
            .setDesc('Âú®‰æßËæπÊ†èÊòæÁ§∫ÁâàÊú¨ÂÜÖÂÆπÈ¢ÑËßà')
            .addToggle(toggle => toggle
                .setValue(this.plugin.settings.sidebarShowPreview)
                .onChange(async (value) => {
                    this.plugin.settings.sidebarShowPreview = value;
                    await this.plugin.saveSettings();
                    this.plugin.updateSidebar();
                }));

        new Setting(containerEl)
            .setName('Á¥ßÂáëÊ®°Âºè')
            .setDesc('‰ΩøÁî®Á¥ßÂáëÂ∏ÉÂ±ÄÊòæÁ§∫Êõ¥Â§öÁâàÊú¨')
            .addToggle(toggle => toggle
                .setValue(this.plugin.settings.sidebarCompactMode)
                .onChange(async (value) => {
                    this.plugin.settings.sidebarCompactMode = value;
                    await this.plugin.saveSettings();
                    this.plugin.updateSidebar();
                }));

        new Setting(containerEl)
            .setName('ÊòæÁ§∫ÁâàÊú¨Êï∞Èáè')
            .setDesc('‰æßËæπÊ†èÊúÄÂ§öÊòæÁ§∫ÁöÑÁâàÊú¨Êï∞Èáè')
            .addSlider(slider => slider
                .setLimits(5, 20, 1)
                .setValue(this.plugin.settings.sidebarMaxVersions)
                .setDynamicTooltip()
                .onChange(async (value) => {
                    this.plugin.settings.sidebarMaxVersions = value;
                    await this.plugin.saveSettings();
                    this.plugin.updateSidebar();
                }));

        containerEl.createEl('h3', { text: 'È´òÁ∫ßËÆæÁΩÆ' });

        new Setting(containerEl)
            .setName('ÂêØÁî®ÁâàÊú¨ÂëΩÂêç')
            .setDesc('ÂÖÅËÆ∏‰∏∫ÁâàÊú¨ËÆæÁΩÆËá™ÂÆö‰πâÂêçÁß∞')
            .addToggle(toggle => toggle
                .setValue(this.plugin.settings.enableVersionNaming)
                .onChange(async (value) => {
                    this.plugin.settings.enableVersionNaming = value;
                    await this.plugin.saveSettings();
                }));

        new Setting(containerEl)
            .setName('ÂêØÁî®Ê†áÁ≠æ')
            .setDesc('ÂÖÅËÆ∏‰∏∫ÁâàÊú¨Ê∑ªÂä†Ê†áÁ≠æ')
            .addToggle(toggle => toggle
                .setValue(this.plugin.settings.enableTags)
                .onChange(async (value) => {
                    this.plugin.settings.enableTags = value;
                    await this.plugin.saveSettings();
                }));

        new Setting(containerEl)
            .setName('ÂêØÁî®Â∑ÆÂºÇÈ´ò‰∫Æ')
            .setDesc('Âú®ÊØîËæÉÁâàÊú¨Êó∂È´ò‰∫ÆÊòæÁ§∫Â∑ÆÂºÇ')
            .addToggle(toggle => toggle
                .setValue(this.plugin.settings.enableDiffHighlight)
                .onChange(async (value) => {
                    this.plugin.settings.enableDiffHighlight = value;
                    await this.plugin.saveSettings();
                }));

        new Setting(containerEl)
            .setName('ÊòæÁ§∫ÂèòÊõ¥È¢ÑËßà')
            .setDesc('Âú®‰øùÂ≠òÂâçÊòæÁ§∫ÂèòÊõ¥È¢ÑËßà')
            .addToggle(toggle => toggle
                .setValue(this.plugin.settings.showChangePreview)
                .onChange(async (value) => {
                    this.plugin.settings.showChangePreview = value;
                    await this.plugin.saveSettings();
                }));

        new Setting(containerEl)
            .setName('ÂêØÁî®ÁâàÊú¨ÂêàÂπ∂')
            .setDesc('ÂÖÅËÆ∏ÂêàÂπ∂Â§ö‰∏™ÁâàÊú¨')
            .addToggle(toggle => toggle
                .setValue(this.plugin.settings.enableVersionMerge)
                .onChange(async (value) => {
                    this.plugin.settings.enableVersionMerge = value;
                    await this.plugin.saveSettings();
                }));

        new Setting(containerEl)
            .setName('‰øùÊä§Âø´ÁÖß')
            .setDesc('Âø´ÁÖß‰∏ç‰ºöË¢´Ëá™Âä®Ê∏ÖÁêÜ')
            .addToggle(toggle => toggle
                .setValue(this.plugin.settings.preserveSnapshots)
                .onChange(async (value) => {
                    this.plugin.settings.preserveSnapshots = value;
                    await this.plugin.saveSettings();
                }));

        new Setting(containerEl)
            .setName('ÊúÄÂ§ßÊêúÁ¥¢ÁªìÊûú')
            .setDesc('ÊêúÁ¥¢ÁâàÊú¨Êó∂ÊòæÁ§∫ÁöÑÊúÄÂ§ßÁªìÊûúÊï∞')
            .addSlider(slider => slider
                .setLimits(10, 200, 10)
                .setValue(this.plugin.settings.maxSearchResults)
                .setDynamicTooltip()
                .onChange(async (value) => {
                    this.plugin.settings.maxSearchResults = value;
                    await this.plugin.saveSettings();
                }));

        containerEl.createEl('h3', { text: 'Áª¥Êä§Êìç‰Ωú' });

        new Setting(containerEl)
            .setName('Êü•ÁúãÁªüËÆ°')
            .setDesc('Êü•ÁúãÁâàÊú¨‰ΩøÁî®ÁªüËÆ°‰ø°ÊÅØ')
            .addButton(btn => btn.setButtonText('ÊâìÂºÄ').onClick(() => {
                new StatsModal(this.app, this.plugin).open();
            }));

        new Setting(containerEl)
            .setName('Ê∏ÖÁêÜÊóßÁâàÊú¨')
            .setDesc('ÊâãÂä®Ê∏ÖÁêÜÊóßÁöÑÁâàÊú¨')
            .addButton(btn => btn.setButtonText('Ê∏ÖÁêÜ').onClick(() => {
                new CleanupModal(this.app, this.plugin).open();
            }));

        new Setting(containerEl)
            .setName('ÁâàÊú¨Êó∂Èó¥Á∫ø')
            .setDesc('Êü•ÁúãÊâÄÊúâÊñá‰ª∂ÁöÑÁâàÊú¨Êó∂Èó¥Á∫ø')
            .addButton(btn => btn.setButtonText('Êü•Áúã').onClick(() => {
                new TimelineModal(this.app, this.plugin).open();
            }));
    }
}

module.exports = VersionControlPlugin;